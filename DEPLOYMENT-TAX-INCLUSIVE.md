# 内税計算への移行デプロイ手順書

## 📋 概要

売上計算を**外税方式**（税抜 + 税額 = 税込）から**内税方式**（入力価格 = 税込）に変更します。

## 🎯 変更内容

### コード変更
1. **計算ロジック**: `app/Filament/Resources/SaleResource/Pages/DailyClosing.php`
   - `updateCalculation()` メソッドを内税計算に変更
   - 税額の計算を削除し、入力価格をそのまま合計

2. **表示変更**: `resources/views/filament/resources/sale-resource/pages/daily-closing.blade.php`
   - モーダルの「小計（税抜）+ 消費税」表示を「小計（税込）」のみに変更
   - リアルタイム反映のため `wire:change` → `wire:input` に変更

### データベース変更
- **既存の売上データ**（外税計算で保存済み）を税抜価格に調整

## ⚠️ 注意事項

### 既存データへの影響
- **外税で保存された売上**は自動的に税抜価格に調整されます
- 例: ¥17,600（税込） → ¥16,000（税抜）に変更

### 今後の運用
- **新規入力価格は税込として扱われます**
- メニュー・オプション・物販の価格は**税込価格**で登録してください
  - 例: ¥1,000（税抜）で提供 → ¥1,100（税込）で登録

## 🚀 デプロイ手順

### ステップ1: コードをデプロイ

```bash
# ローカルで変更をコミット
git add .
git commit -m "feat: 売上計算を内税方式に変更

- updateCalculation()メソッドを内税計算に変更
- モーダル表示を「小計（税込）」のみに簡素化
- リアルタイム反映のためwire:inputに変更
- 既存データ調整用スクリプトを追加"

# 本番環境にプッシュ
git push origin main
```

### ステップ2: GitHub Actionsでデプロイ確認

```bash
# デプロイの進行状況を監視
gh run watch $(gh run list --workflow="Deploy Simple" --limit 1 --json databaseId -q '.[0].databaseId')
```

### ステップ3: 本番環境で既存データを調整

#### 3-1. EC2にSSH接続
```bash
ssh -i /Users/naoki.t/.ssh/xsyumeno-ssh-key.pem ubuntu@54.64.54.226
```

#### 3-2. プロジェクトディレクトリに移動
```bash
cd /var/www/html
```

#### 3-3. 調整対象データを確認（実行前チェック）
```bash
php database/scripts/convert-to-tax-inclusive.php
```

このスクリプトは以下を表示します：
- 調整対象の売上件数
- 各売上の現在の金額と調整後の金額
- 本番環境では確認プロンプトが表示されます

#### 3-4. データ調整を実行
```bash
# 確認プロンプトで "yes" を入力
php database/scripts/convert-to-tax-inclusive.php
```

**実行例**:
```
=== 売上データの内税変換スクリプト ===

📊 調整対象の売上データを確認中...

調整対象: 4件

| sale_id | 日付       | 現在の金額 | 税額合計 | 調整後の金額 |
|---------|------------|-----------|---------|-------------|
| 82      | 2025-10-29 | ¥4,840    | ¥440    | ¥4,400      |
| 83      | 2025-10-29 | ¥550      | ¥50     | ¥500        |
| 85      | 2025-10-29 | ¥14,300   | ¥1,300  | ¥13,000     |
| 54      | 2025-10-28 | ¥1,100    | ¥100    | ¥1,000      |

⚠️  本番環境では手動確認が必要です。
続行しますか？ (yes/no): yes

🔄 データを更新中...

   ✓ sale_items更新: 6件
   ✓ sales更新: 4件

✅ 売上データの内税変換が完了しました！
```

### ステップ4: 動作確認

#### 4-1. 日次精算画面で確認
https://reservation.meno-training.com/admin/sales/daily-closing

確認項目：
- [ ] 既存の売上金額が正しく表示されている
- [ ] 編集モーダルで「小計（税込）」が表示される
- [ ] 単価・数量を変更すると即座に小計が更新される

#### 4-2. 新規売上を計上してテスト
1. 未計上の予約を開く
2. オプション/物販を追加
3. 単価を入力（税込価格として）
4. 小計が即座に更新されることを確認
5. 計上して金額が正しいか確認

## 📊 ロールバック手順（問題が発生した場合）

### コードのロールバック
```bash
# 最新コミットを取り消し
git revert HEAD
git push origin main
```

### データのロールバック
**⚠️ 事前にバックアップを取得していない場合、データを戻すことは困難です**

調整前の状態に戻すには：
```sql
-- sale_itemsに税額を再設定（手動で各明細の税額を計算）
UPDATE sale_items SET tax_amount = FLOOR(amount * 0.1) WHERE ...;

-- salesの合計金額に税額を加算
UPDATE sales SET total_amount = total_amount + (税額合計) WHERE ...;
```

## ✅ チェックリスト

### デプロイ前
- [ ] ローカル環境で動作確認済み
- [ ] 本番データベースのバックアップを取得
- [ ] 調整対象データを確認済み

### デプロイ中
- [ ] GitHub Actionsでデプロイ成功
- [ ] 本番環境でデータ調整スクリプト実行
- [ ] スクリプトが正常終了（✅マーク表示）

### デプロイ後
- [ ] 日次精算画面が正常に表示される
- [ ] 既存売上の金額が正しい
- [ ] 編集モーダルがリアルタイム更新される
- [ ] 新規売上を計上して正しく動作する

## 📞 トラブル時の対応

### スクリプトがエラーで終了した場合
1. エラーメッセージを確認
2. トランザクションは自動的にロールバックされます
3. 原因を特定して再実行

### 金額が正しく表示されない場合
1. ブラウザのキャッシュをクリア（Cmd+Shift+R）
2. データベースで直接確認:
```bash
sqlite3 database/database.sqlite "SELECT * FROM sales WHERE id = XX;"
```

### 連絡先
- 開発者: naoki_takahashi@outlook.com
- GitHub Issues: https://github.com/anthropics/claude-code/issues

---

**作成日**: 2025-10-29
**最終更新**: 2025-10-29
