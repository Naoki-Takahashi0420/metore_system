name: Check OTP History

on:
  workflow_dispatch:
    inputs:
      phone:
        description: 'Phone number to check (optional)'
        required: false
        default: ''

jobs:
  check-otp:
    runs-on: ubuntu-latest

    steps:
    - name: Check OTP History
      env:
        EC2_KEY: ${{ secrets.EC2_KEY }}
        EC2_HOST: 54.64.54.226
        EC2_USER: ubuntu
        PHONE: ${{ github.event.inputs.phone }}
      run: |
        echo "$EC2_KEY" > deploy_key.pem
        chmod 600 deploy_key.pem

        ssh -o StrictHostKeyChecking=no -i deploy_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
        cd /var/www/html

        echo "=== 最近のOTP履歴 (最新10件) ==="
        sudo php artisan tinker --execute="
        \$otps = App\Models\OtpVerification::orderBy('created_at', 'desc')
            ->limit(10)
            ->get(['id', 'phone', 'otp_code', 'created_at', 'verified_at', 'expires_at']);

        foreach (\$otps as \$otp) {
            echo sprintf(
                '[%s] Phone: %s, OTP: %s, Verified: %s, Expires: %s\n',
                \$otp->created_at,
                \$otp->phone,
                \$otp->otp_code,
                \$otp->verified_at ? 'Yes' : 'No',
                \$otp->expires_at
            );
        }
        "

        if [ -n "${PHONE}" ]; then
          echo ""
          echo "=== ${PHONE} のOTP履歴 ==="
          sudo php artisan tinker --execute="
          \$otps = App\Models\OtpVerification::where('phone', 'like', '%${PHONE}%')
              ->orderBy('created_at', 'desc')
              ->limit(20)
              ->get(['id', 'phone', 'otp_code', 'created_at', 'verified_at', 'expires_at']);

          foreach (\$otps as \$otp) {
              echo sprintf(
                  '[%s] OTP: %s, Verified: %s, Expires: %s\n',
                  \$otp->created_at,
                  \$otp->otp_code,
                  \$otp->verified_at ? 'Yes' : 'No',
                  \$otp->expires_at
              );
          }
          "
        fi
        EOF

        rm deploy_key.pem
