name: Stop Reminders

on:
  workflow_dispatch:

jobs:
  stop:
    runs-on: ubuntu-latest

    steps:
    - name: Stop reminder notifications
      env:
        EC2_KEY: ${{ secrets.EC2_KEY }}
        EC2_HOST: 13.158.240.0
        EC2_USER: ubuntu
      run: |
        echo "$EC2_KEY" > deploy_key.pem
        chmod 600 deploy_key.pem

        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=60 -i deploy_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
        cd /var/www/html

        echo "=== ç·Šæ€¥: ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€šçŸ¥ã‚’ä¸€æ™‚åœæ­¢ ==="

        # ã‚­ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’åœæ­¢
        sudo supervisorctl stop laravel-worker:* 2>/dev/null || true
        echo "âœ… ã‚­ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚«ãƒ¼åœæ­¢"

        # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’ä¸€æ™‚åœæ­¢ï¼ˆcronã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
        sudo crontab -u www-data -l > /tmp/www-data-crontab.bak
        sudo crontab -u www-data -l | sed 's/^\* \* \* \* \* cd \/var\/www\/html/#STOPPED# * * * * * cd \/var\/www\/html/' | sudo crontab -u www-data -
        echo "âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼åœæ­¢"

        echo ""
        echo "ç¾åœ¨ã®www-data crontab:"
        sudo crontab -u www-data -l

        echo ""
        echo "ğŸ›‘ ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€šçŸ¥ã‚’åœæ­¢ã—ã¾ã—ãŸ"
        echo "å†é–‹ã™ã‚‹ã«ã¯ restart-reminders ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
        EOF

        rm deploy_key.pem
