name: Investigate Fujisawa Payment V3

on:
  workflow_dispatch:

jobs:
  investigate:
    runs-on: ubuntu-latest

    steps:
    - name: Deep investigation of payment method issue
      env:
        EC2_KEY: ${{ secrets.EC2_KEY }}
        EC2_HOST: 13.158.240.0
        EC2_USER: ubuntu
      run: |
        echo "$EC2_KEY" > deploy_key.pem
        chmod 600 deploy_key.pem

        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=60 -i deploy_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
        cd /var/www/html

        echo "=============================================="
        echo "=== 藤沢店 サブスク決済 詳細調査 V3 ==="
        echo "=============================================="

        echo ""
        echo "【1】問題の3顧客のサブスク契約詳細"
        echo "-------------------------------------------"
        sqlite3 -header -column database/database.sqlite "
        SELECT
            cs.id as sub_id,
            c.last_name || c.first_name as customer,
            cs.payment_method as sub_payment_raw,
            cs.status,
            datetime(cs.created_at, '+9 hours') as created_jst
        FROM customer_subscriptions cs
        JOIN customers c ON cs.customer_id = c.id
        WHERE c.last_name || c.first_name IN ('青木沙月', '岡田佐知子', '廣昌子')
        AND cs.store_id = 8
        ORDER BY cs.id;
        "

        echo ""
        echo "【2】本日の藤沢店売上の詳細（payment_method生値）"
        echo "-------------------------------------------"
        sqlite3 -header -column database/database.sqlite "
        SELECT
            s.id as sale_id,
            c.last_name || c.first_name as customer,
            s.payment_method as sale_payment_raw,
            s.payment_source,
            s.notes,
            datetime(s.created_at, '+9 hours') as created_jst
        FROM sales s
        JOIN customers c ON s.customer_id = c.id
        WHERE s.store_id = 8
        AND date(s.created_at) = date('now')
        ORDER BY s.created_at DESC;
        "

        echo ""
        echo "【3】藤沢店の店舗設定（支払い方法リスト）"
        echo "-------------------------------------------"
        sqlite3 -header -column database/database.sqlite "
        SELECT id, name, payment_methods
        FROM stores
        WHERE id = 8;
        "

        echo ""
        echo "【4】customer_subscriptionsテーブルの payment_method 値一覧（全店舗）"
        echo "-------------------------------------------"
        sqlite3 -header -column database/database.sqlite "
        SELECT payment_method, COUNT(*) as count
        FROM customer_subscriptions
        WHERE status = 'active'
        GROUP BY payment_method
        ORDER BY count DESC;
        "

        echo ""
        echo "【5】salesテーブルの payment_method 値一覧（サブスク関連のみ）"
        echo "-------------------------------------------"
        sqlite3 -header -column database/database.sqlite "
        SELECT payment_method, COUNT(*) as count
        FROM sales
        WHERE payment_source = 'subscription'
        AND date(created_at) >= date('now', '-7 days')
        GROUP BY payment_method
        ORDER BY count DESC;
        "

        echo ""
        echo "【6】サブスク売上のnotesフィールド確認（計上方法の手がかり）"
        echo "-------------------------------------------"
        sqlite3 -header -column database/database.sqlite "
        SELECT
            s.id as sale_id,
            c.last_name || c.first_name as customer,
            s.payment_method,
            substr(s.notes, 1, 60) as notes_prefix
        FROM sales s
        JOIN customers c ON s.customer_id = c.id
        WHERE s.store_id = 8
        AND date(s.created_at) = date('now')
        AND s.customer_subscription_id IS NOT NULL;
        "

        echo ""
        echo "=============================================="
        EOF

        rm deploy_key.pem
