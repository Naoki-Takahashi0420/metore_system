name: Test Email Notification

on:
  workflow_dispatch:

jobs:
  test-email:
    runs-on: ubuntu-latest

    steps:
    - name: Send Test Email
      env:
        EC2_KEY: ${{ secrets.EC2_KEY }}
        EC2_HOST: 54.64.54.226
        EC2_USER: ubuntu
      run: |
        echo "$EC2_KEY" > deploy_key.pem
        chmod 600 deploy_key.pem

        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=60 -i deploy_key.pem ${EC2_USER}@${EC2_HOST} << 'TEST_EMAIL'
        set -e
        APP_DIR="/var/www/html"

        echo "=== ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ ==="

        cd $APP_DIR

        # ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
        sudo php artisan tinker --execute="
        \$emailService = app(\App\Services\EmailService::class);
        \$to = 'dasuna2305@gmail.com';
        \$subject = 'ã€ãƒ†ã‚¹ãƒˆã€‘äºˆç´„é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ å‹•ä½œç¢ºèª';
        \$htmlBody = '
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset=\"UTF-8\">
            <style>
                body { font-family: \"Helvetica Neue\", Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: #059669; padding: 20px; text-align: center; color: white; }
                .content { background: #f9fafb; padding: 20px; border: 1px solid #e5e7eb; }
            </style>
        </head>
        <body>
            <div class=\"container\">
                <div class=\"header\">
                    <h2>ç›®ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° äºˆç´„é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ </h2>
                </div>
                <div class=\"content\">
                    <h3>âœ… ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ</h3>
                    <p>ã‚­ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚</p>
                    <p>é€ä¿¡æ™‚åˆ»: ' . now()->format('Yå¹´mæœˆdæ—¥ H:i:s') . '</p>
                    <hr>
                    <p><strong>ç¢ºèªé …ç›®ï¼š</strong></p>
                    <ul>
                        <li>âœ… ã‚­ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚«ãƒ¼èµ·å‹•ç¢ºèª</li>
                        <li>âœ… ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½ç¢ºèª</li>
                        <li>âœ… äºˆç´„é€šçŸ¥ãŒæ­£å¸¸ã«é€ä¿¡ã•ã‚Œã¾ã™</li>
                    </ul>
                </div>
            </div>
        </body>
        </html>
        ';
        \$textBody = 'ã‚­ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚é€ä¿¡æ™‚åˆ»: ' . now()->format('Yå¹´mæœˆdæ—¥ H:i:s');

        echo 'ğŸ“§ ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ä¸­...' . PHP_EOL;
        \$emailService->sendEmail(\$to, \$subject, \$htmlBody, \$textBody);
        echo 'âœ… ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†ï¼' . PHP_EOL;
        echo 'To: ' . \$to . PHP_EOL;
        "

        echo ""
        echo "=== ã‚­ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚«ãƒ¼çŠ¶æ…‹ç¢ºèª ==="
        ps aux | grep "artisan queue:work" | grep -v grep || echo "ã‚­ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

        echo ""
        echo "=== ã‚¸ãƒ§ãƒ–ã‚­ãƒ¥ãƒ¼ç¢ºèª ==="
        sudo php artisan tinker --execute="
        \$jobCount = \DB::table('jobs')->count();
        echo 'ã‚­ãƒ¥ãƒ¼å†…ã®ã‚¸ãƒ§ãƒ–æ•°: ' . \$jobCount . PHP_EOL;
        if (\$jobCount > 0) {
            echo 'æœ€æ–°ã®ã‚¸ãƒ§ãƒ–:' . PHP_EOL;
            \$jobs = \DB::table('jobs')->orderBy('id', 'desc')->limit(3)->get();
            foreach (\$jobs as \$job) {
                echo '  - ID: ' . \$job->id . ' | Queue: ' . \$job->queue . ' | Attempts: ' . \$job->attempts . PHP_EOL;
            }
        }
        "

        TEST_EMAIL

        rm deploy_key.pem

        echo ""
        echo "âœ… ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
        echo "ğŸ“¬ dasuna2305@gmail.com ã«å±Šã„ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„"
