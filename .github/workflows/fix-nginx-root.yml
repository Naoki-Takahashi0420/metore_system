name: Fix Nginx Document Root

on:
  workflow_dispatch:

jobs:
  fix:
    runs-on: ubuntu-latest
    
    steps:
      - name: Fix Nginx configuration
        env:
          EC2_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          echo "$EC2_KEY" > key.pem
          chmod 600 key.pem
          
          ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@13.115.38.179 << 'EOF'
            echo "=== Current Nginx Config ==="
            cat /etc/nginx/sites-enabled/default
            
            echo -e "\n=== Creating Correct Nginx Configuration ==="
            sudo cat > /tmp/nginx-xsyumeno << 'NGINX'
            server {
                listen 80 default_server;
                listen [::]:80 default_server;
                
                root /var/www/html/current/public;
                index index.php index.html index.htm;
                
                server_name _;
                
                location / {
                    try_files $uri $uri/ /index.php?$query_string;
                }
                
                location ~ \.php$ {
                    include snippets/fastcgi-php.conf;
                    fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
                    fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
                    include fastcgi_params;
                }
                
                location ~ /\.ht {
                    deny all;
                }
                
                location ~ /\.(?!well-known).* {
                    deny all;
                }
            }
            NGINX
            
            # バックアップ作成
            sudo cp /etc/nginx/sites-enabled/default /etc/nginx/sites-enabled/default.backup
            
            # 新しい設定を適用
            sudo cp /tmp/nginx-xsyumeno /etc/nginx/sites-enabled/default
            
            # Nginx設定テスト
            echo -e "\n=== Testing Nginx Configuration ==="
            sudo nginx -t
            
            # Nginx再起動
            echo -e "\n=== Restarting Nginx ==="
            sudo systemctl restart nginx
            
            # 確認
            echo -e "\n=== Verifying Document Root ==="
            grep "root" /etc/nginx/sites-enabled/default
            
            echo -e "\n=== Testing Application ==="
            curl -I http://localhost/
            curl -I http://localhost/admin/login
            
            echo -e "\n=== Fix Complete ==="
            echo "Nginx now serving from: /var/www/html/current/public"
            echo "Please test: http://13.115.38.179/admin/login"
          EOF
          
          rm key.pem