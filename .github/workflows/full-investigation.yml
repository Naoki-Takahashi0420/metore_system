name: Full Investigation

on:
  workflow_dispatch:

jobs:
  investigate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Complete investigation of 500 error
        env:
          EC2_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          echo "$EC2_KEY" > key.pem
          chmod 600 key.pem
          
          ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@13.115.38.179 << 'EOF'
            echo "ğŸ•µï¸ FULL INVESTIGATION MODE ğŸ•µï¸"
            
            cd /var/www/html/current
            
            # 1. åŸºæœ¬æƒ…å ±
            echo "=== BASIC INFO ==="
            pwd
            whoami
            date
            
            # 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ§‹é€ 
            echo -e "\n=== APP STRUCTURE ==="
            ls -la | head -20
            
            # 3. ç’°å¢ƒè¨­å®šç¢ºèª
            echo -e "\n=== ENVIRONMENT CHECK ==="
            grep -E "APP_DEBUG|APP_ENV|DB_" .env
            
            # 4. Webã‚µãƒ¼ãƒãƒ¼è¨­å®š
            echo -e "\n=== NGINX CONFIG ==="
            cat /etc/nginx/sites-enabled/default | head -30
            
            # 5. PHPè¨­å®š
            echo -e "\n=== PHP INFO ==="
            php -v
            php --ini | head -5
            
            # 6. Laravelãƒãƒ¼ã‚¸ãƒ§ãƒ³
            echo -e "\n=== LARAVEL VERSION ==="
            php artisan --version
            
            # 7. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ
            echo -e "\n=== DATABASE TEST ==="
            php artisan tinker --execute="
              try {
                \$pdo = DB::connection()->getPdo();
                echo 'DB Connection: SUCCESS';
                echo '\nDB Name: ' . \$pdo->query('select database()')->fetchColumn();
              } catch(Exception \$e) {
                echo 'DB Connection: FAILED - ' . \$e->getMessage();
              }
            "
            
            # 8. ãƒ«ãƒ¼ãƒˆç¢ºèª
            echo -e "\n=== ROUTES CHECK ==="
            php artisan route:list | grep -E "admin|livewire" | head -10
            
            # 9. Livewireè¨­å®š
            echo -e "\n=== LIVEWIRE CONFIG ==="
            php artisan tinker --execute="
              if(class_exists('Livewire\Livewire')) {
                echo 'Livewire: INSTALLED';
              } else {
                echo 'Livewire: NOT FOUND';
              }
            "
            
            # 10. å®Ÿéš›ã®HTTPãƒ†ã‚¹ãƒˆ
            echo -e "\n=== HTTP TESTS ==="
            
            echo "Testing homepage:"
            curl -s -I http://localhost/ | head -10
            
            echo -e "\nTesting admin login page:"
            curl -s -I http://localhost/admin/login | head -10
            
            echo -e "\nTesting Livewire JS:"
            curl -s -I http://localhost/livewire/livewire.min.js | head -10
            
            # 11. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è©³ç´°
            echo -e "\n=== ERROR LOGS DETAIL ==="
            
            echo "Latest Nginx errors (last 20):"
            tail -20 /var/log/nginx/error.log | grep "error\|Error\|ERROR" | tail -10
            
            echo -e "\nLatest PHP-FPM errors (last 20):"
            tail -20 /var/log/php8.3-fpm.log | grep -v "NOTICE" | tail -10
            
            echo -e "\nLatest Laravel errors (last 30):"
            tail -30 storage/logs/laravel.log | grep -E "ERROR|Exception|Fatal" | tail -10
            
            # 12. æ¨©é™ç¢ºèª
            echo -e "\n=== PERMISSIONS CHECK ==="
            ls -la storage/ | head -5
            ls -la bootstrap/cache/ | head -5
            
            # 13. ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª
            echo -e "\n=== PROCESS CHECK ==="
            ps aux | grep -E "php|nginx" | grep -v grep | head -5
            
            # 14. ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡
            echo -e "\n=== DISK SPACE ==="
            df -h | grep -E "Filesystem|/dev"
            
            # 15. æœ€å¾Œã«ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆç”¨ã®è©³ç´°ãƒ¬ã‚¹ãƒãƒ³ã‚¹
            echo -e "\n=== DETAILED RESPONSE TEST ==="
            echo "Full response from /admin/login:"
            timeout 10 curl -v http://localhost/admin/login 2>&1 | head -50
            
            echo -e "\nğŸ•µï¸ INVESTIGATION COMPLETE ğŸ•µï¸"
          EOF
          
          rm key.pem