name: Fix Robopay to Japanese

on:
  workflow_dispatch:

jobs:
  fix:
    runs-on: ubuntu-latest

    steps:
    - name: Update robopay to ロボットペイメント
      env:
        EC2_KEY: ${{ secrets.EC2_KEY }}
        EC2_HOST: 13.158.240.0
        EC2_USER: ubuntu
      run: |
        echo "$EC2_KEY" > deploy_key.pem
        chmod 600 deploy_key.pem

        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=60 -i deploy_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
        cd /var/www/html

        echo "=============================================="
        echo "=== robopay → ロボットペイメント 更新 ==="
        echo "=============================================="

        echo ""
        echo "【更新前】salesテーブルの payment_method 分布"
        echo "-------------------------------------------"
        sqlite3 -header -column database/database.sqlite "
        SELECT payment_method, COUNT(*) as count
        FROM sales
        WHERE payment_method IN ('robopay', 'ロボットペイメント')
        GROUP BY payment_method;
        "

        echo ""
        echo "【更新前】customer_subscriptionsテーブルの payment_method 分布"
        echo "-------------------------------------------"
        sqlite3 -header -column database/database.sqlite "
        SELECT payment_method, COUNT(*) as count
        FROM customer_subscriptions
        WHERE payment_method IN ('robopay', 'ロボットペイメント')
        GROUP BY payment_method;
        "

        echo ""
        echo "=== 更新実行 ==="
        echo ""

        echo "salesテーブル更新中..."
        sudo -u www-data sqlite3 database/database.sqlite "
        UPDATE sales
        SET payment_method = 'ロボットペイメント'
        WHERE payment_method = 'robopay';
        "
        echo "完了"

        echo ""
        echo "customer_subscriptionsテーブル更新中..."
        sudo -u www-data sqlite3 database/database.sqlite "
        UPDATE customer_subscriptions
        SET payment_method = 'ロボットペイメント'
        WHERE payment_method = 'robopay';
        "
        echo "完了"

        echo ""
        echo "【更新後】salesテーブルの payment_method 分布"
        echo "-------------------------------------------"
        sqlite3 -header -column database/database.sqlite "
        SELECT payment_method, COUNT(*) as count
        FROM sales
        WHERE payment_method IN ('robopay', 'ロボットペイメント')
        GROUP BY payment_method;
        "

        echo ""
        echo "【更新後】customer_subscriptionsテーブルの payment_method 分布"
        echo "-------------------------------------------"
        sqlite3 -header -column database/database.sqlite "
        SELECT payment_method, COUNT(*) as count
        FROM customer_subscriptions
        WHERE payment_method IN ('robopay', 'ロボットペイメント')
        GROUP BY payment_method;
        "

        echo ""
        echo "【確認】藤沢店の本日の売上"
        echo "-------------------------------------------"
        sqlite3 -header -column database/database.sqlite "
        SELECT
            s.id as sale_id,
            c.last_name || c.first_name as customer,
            s.payment_method,
            s.total_amount
        FROM sales s
        JOIN customers c ON s.customer_id = c.id
        WHERE s.store_id = 8
        AND date(s.created_at) = date('now')
        AND s.customer_subscription_id IS NOT NULL;
        "

        echo ""
        echo "=============================================="
        echo "=== 更新完了 ==="
        echo "=============================================="
        EOF

        rm deploy_key.pem
