name: Investigate Saito Sale

on:
  workflow_dispatch:

jobs:
  investigate:
    runs-on: ubuntu-latest

    steps:
    - name: Investigate Saito Sonomi subscription
      env:
        EC2_KEY: ${{ secrets.EC2_KEY }}
        EC2_HOST: 13.158.240.0
        EC2_USER: ubuntu
      run: |
        echo "$EC2_KEY" > deploy_key.pem
        chmod 600 deploy_key.pem

        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=60 -i deploy_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
        cd /var/www/html

        echo "=============================================="
        echo "=== 斉藤園巳 サブスク契約詳細 ==="
        echo "=============================================="

        echo ""
        echo "【1】サブスク契約の全カラム"
        echo "-------------------------------------------"
        sqlite3 -header -column database/database.sqlite "
        SELECT *
        FROM customer_subscriptions
        WHERE id = 81;
        "

        echo ""
        echo "【2】次回請求日・請求開始日"
        echo "-------------------------------------------"
        sqlite3 -header -column database/database.sqlite "
        SELECT
            cs.id,
            c.last_name || c.first_name as customer,
            cs.billing_start_date,
            cs.next_billing_date,
            cs.payment_method,
            cs.status,
            datetime(cs.created_at, '+9 hours') as created_jst,
            datetime(cs.updated_at, '+9 hours') as updated_jst
        FROM customer_subscriptions cs
        JOIN customers c ON cs.customer_id = c.id
        WHERE cs.id = 81;
        "

        echo ""
        echo "【3】本日（1/7 JST）は何日？"
        echo "-------------------------------------------"
        echo "現在時刻(JST): $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S')"
        echo "現在時刻(UTC): $(date '+%Y-%m-%d %H:%M:%S')"

        echo ""
        echo "【4】斉藤園巳の全売上（直近）"
        echo "-------------------------------------------"
        sqlite3 -header -column database/database.sqlite "
        SELECT
            s.id as sale_id,
            date(datetime(s.created_at, '+9 hours')) as sale_date,
            s.total_amount,
            s.payment_source,
            substr(s.notes, 1, 40) as notes
        FROM sales s
        JOIN customers c ON s.customer_id = c.id
        WHERE c.last_name || c.first_name = '斉藤園巳'
        ORDER BY s.created_at DESC
        LIMIT 10;
        "

        echo ""
        echo "【5】サブスクID=81の売上履歴"
        echo "-------------------------------------------"
        sqlite3 -header -column database/database.sqlite "
        SELECT
            s.id as sale_id,
            date(datetime(s.created_at, '+9 hours')) as sale_date,
            s.total_amount,
            substr(s.notes, 1, 50) as notes
        FROM sales s
        WHERE s.customer_subscription_id = 81
        ORDER BY s.created_at DESC
        LIMIT 10;
        "

        echo ""
        echo "=============================================="
        EOF

        rm deploy_key.pem
