name: Emergency Debug Mode

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
      - name: TURN ON DEBUG MODE AND FIND THE ERROR
        env:
          EC2_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          echo "$EC2_KEY" > key.pem
          chmod 600 key.pem
          
          ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@13.115.38.179 << 'EOF'
            cd /var/www/html/current
            
            echo "🔥🔥🔥 EMERGENCY DEBUG MODE 🔥🔥🔥"
            echo "Let's find this damn error once and for all!"
            
            # 1. デバッグモードを強制ON
            echo -e "\n=== FORCE DEBUG MODE ON ==="
            sed -i 's/APP_DEBUG=false/APP_DEBUG=true/' .env
            sed -i 's/APP_ENV=production/APP_ENV=local/' .env
            sed -i 's/LOG_LEVEL=error/LOG_LEVEL=debug/' .env
            
            # 2. エラー表示を最大に
            echo -e "\n=== MAXIMUM ERROR REPORTING ==="
            cat >> .env << 'ERRORS'

# MAXIMUM ERROR DISPLAY
APP_DEBUG=true
LOG_LEVEL=debug
LIVEWIRE_LEGACY_MODEL_BINDING=false
LIVEWIRE_RENDER_ON_REDIRECT=true
ERRORS
            
            # 3. キャッシュを完全削除
            echo -e "\n=== NUCLEAR CACHE CLEAR ==="
            php artisan config:clear
            php artisan cache:clear  
            php artisan view:clear
            php artisan route:clear
            php artisan optimize:clear
            rm -rf bootstrap/cache/*.php
            rm -rf storage/framework/cache/*
            rm -rf storage/framework/sessions/*
            rm -rf storage/framework/views/*
            
            # 4. 権限再設定
            echo -e "\n=== FIX PERMISSIONS ==="
            sudo chown -R www-data:www-data .
            sudo chmod -R 777 storage
            sudo chmod -R 777 bootstrap/cache
            
            # 5. サービス再起動
            echo -e "\n=== RESTART EVERYTHING ==="
            sudo systemctl restart php8.3-fpm
            sudo systemctl restart nginx
            
            # 6. テスト実行してエラー確認
            echo -e "\n=== TEST AND CAPTURE ERRORS ==="
            sleep 2
            
            echo "Testing homepage..."
            curl -s http://localhost/ | head -100
            
            echo -e "\nTesting admin page..."
            curl -s http://localhost/admin/login | head -100
            
            echo -e "\nTesting Livewire update..."
            curl -X POST http://localhost/livewire/update \
              -H "Content-Type: application/json" \
              -d '{"fingerprint":{"id":"test","name":"test"},"serverMemo":{},"updates":[]}' \
              -s | head -100
            
            # 7. ログ確認
            echo -e "\n=== ERROR LOGS ==="
            echo "Nginx errors:"
            tail -20 /var/log/nginx/error.log | head -20
            
            echo -e "\nPHP-FPM errors:"
            tail -20 /var/log/php8.3-fpm.log | head -20
            
            echo -e "\nLaravel errors:"
            tail -50 storage/logs/laravel.log | head -50
            
            echo -e "\n🔥🔥🔥 NOW CHECK YOUR BROWSER 🔥🔥🔥"
            echo "URL: http://13.115.38.179/admin/login"
            echo "Debug mode is ON - you should see detailed error messages!"
            echo "If you still see 500, check browser console (F12)!"
          EOF
          
          rm key.pem