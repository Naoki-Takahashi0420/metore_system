name: Update Oyama Subscription Limit

on:
  workflow_dispatch:

jobs:
  update-limit:
    runs-on: ubuntu-latest

    steps:
    - name: Update Oyama subscription monthly limit 6â†’5
      env:
        EC2_KEY: ${{ secrets.EC2_KEY }}
        EC2_HOST: 54.64.54.226
        EC2_USER: ubuntu
      run: |
        echo "$EC2_KEY" > deploy_key.pem
        chmod 600 deploy_key.pem

        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=60 -i deploy_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
        cd /var/www/html

        echo "=== å¤‰æ›´å‰ã®ç¢ºèª ==="
        sqlite3 database/database.sqlite "SELECT 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼(max_monthly_usage=6): ' || COUNT(*) FROM menus WHERE store_id = 2 AND is_subscription = 1 AND max_monthly_usage = 6;"
        sqlite3 database/database.sqlite "SELECT 'å¥‘ç´„(monthly_limit=6): ' || COUNT(*) FROM customer_subscriptions WHERE store_id = 2 AND monthly_limit = 6;"

        echo ""
        echo "=== æ›´æ–°å®Ÿè¡Œ ==="

        # ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æœˆé–“ä¸Šé™ã‚’5ã«
        sqlite3 database/database.sqlite "UPDATE menus SET max_monthly_usage = 5 WHERE store_id = 2 AND is_subscription = 1 AND max_monthly_usage = 6;"
        echo "âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ›´æ–°å®Œäº†"

        # æ—¢å­˜å¥‘ç´„ã®æœˆé–“ä¸Šé™ã‚’5ã«
        sqlite3 database/database.sqlite "UPDATE customer_subscriptions SET monthly_limit = 5 WHERE store_id = 2 AND monthly_limit = 6;"
        echo "âœ… å¥‘ç´„æ›´æ–°å®Œäº†"

        echo ""
        echo "=== å¤‰æ›´å¾Œã®ç¢ºèª ==="
        sqlite3 database/database.sqlite "SELECT 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼(max_monthly_usage=6): ' || COUNT(*) FROM menus WHERE store_id = 2 AND is_subscription = 1 AND max_monthly_usage = 6;"
        sqlite3 database/database.sqlite "SELECT 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼(max_monthly_usage=5): ' || COUNT(*) FROM menus WHERE store_id = 2 AND is_subscription = 1 AND max_monthly_usage = 5;"
        sqlite3 database/database.sqlite "SELECT 'å¥‘ç´„(monthly_limit=6): ' || COUNT(*) FROM customer_subscriptions WHERE store_id = 2 AND monthly_limit = 6;"
        sqlite3 database/database.sqlite "SELECT 'å¥‘ç´„(monthly_limit=5): ' || COUNT(*) FROM customer_subscriptions WHERE store_id = 2 AND monthly_limit = 5;"

        echo ""
        echo "ðŸŽ‰ å°å±±åº—ã‚µãƒ–ã‚¹ã‚¯æœˆé–“ä¸Šé™ã®å¤‰æ›´å®Œäº†ï¼ˆ6â†’5ï¼‰"
        EOF

        rm deploy_key.pem
