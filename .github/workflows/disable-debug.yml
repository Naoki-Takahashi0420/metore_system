name: Disable Debug Mode

on:
  workflow_dispatch:

jobs:
  disable-debug:
    runs-on: ubuntu-latest

    steps:
    - name: Disable Debug on Production
      env:
        EC2_KEY: ${{ secrets.EC2_KEY }}
        EC2_HOST: 54.64.54.226
        EC2_USER: ubuntu
      run: |
        echo "$EC2_KEY" > deploy_key.pem
        chmod 600 deploy_key.pem

        ssh -o StrictHostKeyChecking=no -i deploy_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
        set -e
        cd /var/www/html

        # .envのAPP_DEBUGをfalseに設定
        if grep -q "APP_DEBUG=true" .env; then
          sudo sed -i 's/APP_DEBUG=true/APP_DEBUG=false/' .env
          echo "✅ APP_DEBUG changed to false"
        else
          echo "ℹ️ APP_DEBUG already false"
        fi

        # キャッシュクリア
        sudo php artisan config:clear
        sudo php artisan cache:clear

        echo "✅ Debug mode disabled!"
        EOF

        rm deploy_key.pem
