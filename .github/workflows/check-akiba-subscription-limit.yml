name: Check Akiba Subscription Limit

on:
  workflow_dispatch:

jobs:
  check-limit:
    runs-on: ubuntu-latest

    steps:
    - name: Check Akiba subscription monthly limit
      env:
        EC2_KEY: ${{ secrets.EC2_KEY }}
        EC2_HOST: 13.158.240.0
        EC2_USER: ubuntu
      run: |
        echo "$EC2_KEY" > deploy_key.pem
        chmod 600 deploy_key.pem

        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=60 -i deploy_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
        cd /var/www/html

        echo "=== AKIBA末広町店(store_id=4)サブスク設定確認 ==="
        echo ""
        echo "【メニュー max_monthly_usage 分布】"
        sqlite3 database/database.sqlite "SELECT 'max_monthly_usage=' || COALESCE(max_monthly_usage, 'NULL') || ': ' || COUNT(*) || '件' FROM menus WHERE store_id = 4 AND is_subscription = 1 GROUP BY max_monthly_usage;"

        echo ""
        echo "【契約 monthly_limit 分布】"
        sqlite3 database/database.sqlite "SELECT 'monthly_limit=' || COALESCE(monthly_limit, 'NULL') || ': ' || COUNT(*) || '件' FROM customer_subscriptions WHERE store_id = 4 AND status = 'active' GROUP BY monthly_limit;"

        echo ""
        echo "【アクティブ契約サンプル（最新5件）】"
        sqlite3 -header -column database/database.sqlite "SELECT cs.id, c.last_name || c.first_name as customer_name, cs.plan_name, cs.monthly_limit FROM customer_subscriptions cs LEFT JOIN customers c ON cs.customer_id = c.id WHERE cs.store_id = 4 AND cs.status = 'active' ORDER BY cs.id DESC LIMIT 5;"
        EOF

        rm deploy_key.pem
