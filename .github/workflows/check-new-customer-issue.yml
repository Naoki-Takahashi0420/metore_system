name: Check New Customer Issue

on:
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
    - name: Check customer data
      env:
        EC2_KEY: ${{ secrets.EC2_KEY }}
        EC2_HOST: 13.158.240.0
        EC2_USER: ubuntu
      run: |
        echo "$EC2_KEY" > deploy_key.pem
        chmod 600 deploy_key.pem

        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -i deploy_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
        cd /var/www/html

        echo "=========================================="
        echo "【回数券キャンセル返却調査】"
        echo "=========================================="

        echo ""
        echo "=== 1. 林徹様の調査 ==="
        echo "--- 顧客情報 ---"
        sqlite3 database/database.sqlite "SELECT id, name, phone, email FROM customers WHERE name LIKE '%林徹%' OR name LIKE '%林%徹%' LIMIT 5;"

        echo ""
        echo "--- 林徹様の回数券（customer_tickets） ---"
        sqlite3 database/database.sqlite "SELECT ct.id, ct.customer_id, tp.name as plan_name, ct.total_count, ct.used_count, ct.remaining_count, ct.status, ct.created_at
        FROM customer_tickets ct
        JOIN ticket_plans tp ON ct.ticket_plan_id = tp.id
        WHERE ct.customer_id IN (SELECT id FROM customers WHERE name LIKE '%林徹%' OR name LIKE '%林%徹%');"

        echo ""
        echo "--- 林徹様のキャンセル予約（回数券関連） ---"
        sqlite3 database/database.sqlite "SELECT r.id, r.reservation_date, r.status, r.customer_ticket_id, r.paid_with_ticket, m.name as menu_name, r.updated_at
        FROM reservations r
        LEFT JOIN menus m ON r.menu_id = m.id
        WHERE r.customer_id IN (SELECT id FROM customers WHERE name LIKE '%林徹%' OR name LIKE '%林%徹%')
        AND (r.status IN ('cancelled', 'canceled') OR r.customer_ticket_id IS NOT NULL)
        ORDER BY r.reservation_date DESC LIMIT 10;"

        echo ""
        echo "=== 2. 奈良場宏一様の調査 ==="
        echo "--- 顧客情報 ---"
        sqlite3 database/database.sqlite "SELECT id, name, phone, email FROM customers WHERE name LIKE '%奈良場%' OR name LIKE '%宏一%' LIMIT 5;"

        echo ""
        echo "--- 奈良場宏一様の回数券（customer_tickets） ---"
        sqlite3 database/database.sqlite "SELECT ct.id, ct.customer_id, tp.name as plan_name, ct.total_count, ct.used_count, ct.remaining_count, ct.status, ct.created_at
        FROM customer_tickets ct
        JOIN ticket_plans tp ON ct.ticket_plan_id = tp.id
        WHERE ct.customer_id IN (SELECT id FROM customers WHERE name LIKE '%奈良場%' OR name LIKE '%宏一%');"

        echo ""
        echo "--- 奈良場宏一様のキャンセル予約（回数券関連） ---"
        sqlite3 database/database.sqlite "SELECT r.id, r.reservation_date, r.status, r.customer_ticket_id, r.paid_with_ticket, m.name as menu_name, r.updated_at
        FROM reservations r
        LEFT JOIN menus m ON r.menu_id = m.id
        WHERE r.customer_id IN (SELECT id FROM customers WHERE name LIKE '%奈良場%' OR name LIKE '%宏一%')
        AND (r.status IN ('cancelled', 'canceled') OR r.customer_ticket_id IS NOT NULL)
        ORDER BY r.reservation_date DESC LIMIT 10;"

        echo ""
        echo "=== 3. 回数券使用履歴テーブル確認 ==="
        echo "--- ticket_usage_histories テーブル構造 ---"
        sqlite3 database/database.sqlite ".schema ticket_usage_histories" 2>/dev/null || echo "テーブルなし"

        echo ""
        echo "--- 林徹様の使用履歴 ---"
        sqlite3 database/database.sqlite "SELECT * FROM ticket_usage_histories WHERE customer_ticket_id IN (
          SELECT ct.id FROM customer_tickets ct WHERE ct.customer_id IN (SELECT id FROM customers WHERE name LIKE '%林徹%')
        );" 2>/dev/null || echo "履歴なし"

        echo ""
        echo "--- 奈良場宏一様の使用履歴 ---"
        sqlite3 database/database.sqlite "SELECT * FROM ticket_usage_histories WHERE customer_ticket_id IN (
          SELECT ct.id FROM customer_tickets ct WHERE ct.customer_id IN (SELECT id FROM customers WHERE name LIKE '%奈良場%')
        );" 2>/dev/null || echo "履歴なし"

        echo ""
        echo "=========================================="
        echo "【通知重複問題の調査】"
        echo "=========================================="

        echo ""
        echo "=== 4. 直近の通知ログ（重複確認） ==="
        echo "--- 過去3日間の通知ログ（同じ予約IDで複数通知） ---"
        sqlite3 database/database.sqlite "SELECT reservation_id, COUNT(*) as cnt, GROUP_CONCAT(id) as log_ids, type, channel
        FROM notification_logs
        WHERE created_at >= datetime('now', '-3 days')
        AND reservation_id IS NOT NULL
        GROUP BY reservation_id, type, channel
        HAVING COUNT(*) > 1
        ORDER BY cnt DESC
        LIMIT 20;"

        echo ""
        echo "--- 直近の予約変更通知 ---"
        sqlite3 database/database.sqlite "SELECT id, customer_id, reservation_id, type, channel, status, created_at
        FROM notification_logs
        WHERE type LIKE '%change%' OR type LIKE '%変更%'
        ORDER BY created_at DESC
        LIMIT 20;"

        echo ""
        echo "=== 5. 管理者通知の重複確認 ==="
        sqlite3 database/database.sqlite "SELECT email, COUNT(*) as cnt
        FROM notification_logs
        WHERE channel = 'email'
        AND created_at >= datetime('now', '-7 days')
        GROUP BY email, reservation_id, type
        HAVING COUNT(*) > 1
        ORDER BY cnt DESC
        LIMIT 10;"

        echo ""
        echo "=== 6. AdminNotificationService のログ確認 ==="
        echo "--- 直近のAdmin通知関連ログ ---"
        sudo grep -i "AdminNotification\|admin.*notification\|重複\|duplicate" /var/www/html/storage/logs/laravel-$(date +%F).log 2>/dev/null | tail -30 || echo "ログなし"

        echo ""
        echo "=========================================="
        echo "調査完了"
        echo "=========================================="
        EOF

        rm deploy_key.pem
