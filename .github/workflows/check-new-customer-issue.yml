name: Check New Customer Issue

on:
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
    - name: Check customer data
      env:
        EC2_KEY: ${{ secrets.EC2_KEY }}
        EC2_HOST: 13.158.240.0
        EC2_USER: ubuntu
      run: |
        echo "$EC2_KEY" > deploy_key.pem
        chmod 600 deploy_key.pem

        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -i deploy_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
        cd /var/www/html

        echo "=========================================="
        echo "【テーブル構造確認】"
        echo "=========================================="

        echo "=== customers テーブル構造 ==="
        sqlite3 database/database.sqlite ".schema customers" | head -30

        echo ""
        echo "=== customer_tickets テーブル構造 ==="
        sqlite3 database/database.sqlite ".schema customer_tickets"

        echo ""
        echo "=========================================="
        echo "【回数券キャンセル返却調査】"
        echo "=========================================="

        echo ""
        echo "=== 1. 林徹様の調査 ==="
        echo "--- 顧客情報 ---"
        sqlite3 database/database.sqlite "SELECT id, last_name, first_name, phone, email FROM customers WHERE (last_name || first_name) LIKE '%林徹%' OR last_name LIKE '%林%' LIMIT 5;"

        echo ""
        echo "--- 林徹様の回数券（customer_tickets） ---"
        sqlite3 database/database.sqlite "SELECT ct.id, ct.customer_id, tp.name as plan_name, ct.total_count, ct.used_count, (ct.total_count - ct.used_count) as remaining, ct.status, ct.created_at
        FROM customer_tickets ct
        JOIN ticket_plans tp ON ct.ticket_plan_id = tp.id
        WHERE ct.customer_id IN (SELECT id FROM customers WHERE (last_name || first_name) LIKE '%林徹%' OR last_name LIKE '%林%');"

        echo ""
        echo "--- 林徹様の全予約（回数券関連） ---"
        sqlite3 database/database.sqlite "SELECT r.id, r.reservation_date, r.status, r.customer_ticket_id, r.paid_with_ticket, m.name as menu_name, r.updated_at
        FROM reservations r
        LEFT JOIN menus m ON r.menu_id = m.id
        WHERE r.customer_id IN (SELECT id FROM customers WHERE (last_name || first_name) LIKE '%林徹%' OR last_name LIKE '%林%')
        ORDER BY r.reservation_date DESC LIMIT 15;"

        echo ""
        echo "=== 2. 奈良場宏一様の調査 ==="
        echo "--- 顧客情報 ---"
        sqlite3 database/database.sqlite "SELECT id, last_name, first_name, phone, email FROM customers WHERE (last_name || first_name) LIKE '%奈良場%' OR last_name LIKE '%奈良場%' LIMIT 5;"

        echo ""
        echo "--- 奈良場宏一様の回数券（customer_tickets） ---"
        sqlite3 database/database.sqlite "SELECT ct.id, ct.customer_id, tp.name as plan_name, ct.total_count, ct.used_count, (ct.total_count - ct.used_count) as remaining, ct.status, ct.created_at
        FROM customer_tickets ct
        JOIN ticket_plans tp ON ct.ticket_plan_id = tp.id
        WHERE ct.customer_id IN (SELECT id FROM customers WHERE (last_name || first_name) LIKE '%奈良場%' OR last_name LIKE '%奈良場%');"

        echo ""
        echo "--- 奈良場宏一様の全予約（回数券関連） ---"
        sqlite3 database/database.sqlite "SELECT r.id, r.reservation_date, r.status, r.customer_ticket_id, r.paid_with_ticket, m.name as menu_name, r.updated_at
        FROM reservations r
        LEFT JOIN menus m ON r.menu_id = m.id
        WHERE r.customer_id IN (SELECT id FROM customers WHERE (last_name || first_name) LIKE '%奈良場%' OR last_name LIKE '%奈良場%')
        ORDER BY r.reservation_date DESC LIMIT 15;"

        echo ""
        echo "=========================================="
        echo "【管理者通知の重複原因調査】"
        echo "=========================================="

        echo ""
        echo "=== 重複ログ詳細（直近5件の予約ID毎） ==="
        for id in 3835 3834 3833 3830 3829; do
          echo "--- 予約ID: $id ---"
          grep "reservation_id.:.$id" /var/www/html/storage/logs/laravel-$(date +%F).log 2>/dev/null | grep -i "admin\|notification" | head -5
          echo ""
        done

        echo ""
        echo "=========================================="
        echo "調査完了"
        echo "=========================================="
        EOF

        rm deploy_key.pem
