name: Disk Cleanup

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'check'
        type: choice
        options:
          - check
          - cleanup

jobs:
  disk-cleanup:
    runs-on: ubuntu-latest

    steps:
    - name: Disk Cleanup
      env:
        EC2_KEY: ${{ secrets.EC2_KEY }}
        EC2_HOST: 54.64.54.226
        EC2_USER: ubuntu
        ACTION: ${{ github.event.inputs.action }}
      run: |
        echo "$EC2_KEY" > deploy_key.pem
        chmod 600 deploy_key.pem

        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=60 -i deploy_key.pem ${EC2_USER}@${EC2_HOST} << 'CLEANUP'

        echo "=========================================="
        echo "=== ãƒ‡ã‚£ã‚¹ã‚¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—: $ACTION ==="
        echo "=========================================="

        echo ""
        echo "=== ç¾åœ¨ã®ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨çŠ¶æ³ ==="
        df -h /

        if [ "$ACTION" = "check" ]; then
          echo ""
          echo "=== ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ï¼ˆã‚µã‚¤ã‚ºé †ï¼‰==="
          sudo ls -lhS /var/www/html/storage/logs/ 2>/dev/null | head -20

          echo ""
          echo "=== å‰Šé™¤å¯¾è±¡: å¤ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ11æœˆä»¥å‰ï¼‰==="
          sudo find /var/www/html/storage/logs -name "laravel-2025-0*.log" -o -name "laravel-2025-10-*.log" -o -name "laravel-2025-11-*.log" 2>/dev/null | xargs ls -lh 2>/dev/null || echo "ãªã—"

          echo ""
          echo "=== ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚µã‚¤ã‚º ==="
          sudo du -sh /var/www/html/storage/framework/cache/ 2>/dev/null || echo "cache: 0"
          sudo du -sh /var/www/html/storage/framework/views/ 2>/dev/null || echo "views: 0"
          sudo du -sh /var/www/html/storage/framework/sessions/ 2>/dev/null || echo "sessions: 0"

          echo ""
          echo "=== APTã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚º ==="
          sudo du -sh /var/cache/apt/archives/ 2>/dev/null || echo "apt: 0"

          echo ""
          echo "=== ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ­ã‚°ã‚µã‚¤ã‚º ==="
          sudo journalctl --disk-usage 2>/dev/null || echo "ä¸æ˜"

          echo ""
          echo "=== ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåˆ¥ä½¿ç”¨é‡TOP10 ==="
          sudo du -h /var/www/html --max-depth=2 2>/dev/null | sort -rh | head -10

        elif [ "$ACTION" = "cleanup" ]; then
          echo ""
          echo "ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹..."

          # 1. å¤ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ï¼ˆ12æœˆã¯æ®‹ã™ï¼‰
          echo ""
          echo "ğŸ“‹ å¤ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ä¸­..."
          sudo find /var/www/html/storage/logs -name "laravel-2025-0*.log" -delete 2>/dev/null
          sudo find /var/www/html/storage/logs -name "laravel-2025-10-*.log" -delete 2>/dev/null
          sudo find /var/www/html/storage/logs -name "laravel-2025-11-*.log" -delete 2>/dev/null
          echo "âœ… å¤ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤å®Œäº†"

          # 2. Laravelã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
          echo ""
          echo "âš¡ Laravelã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ä¸­..."
          cd /var/www/html
          sudo php artisan cache:clear
          sudo php artisan view:clear
          sudo php artisan config:clear
          echo "âœ… Laravelã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å®Œäº†"

          # 3. æœŸé™åˆ‡ã‚Œã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ï¼ˆ7æ—¥ä»¥ä¸Šå‰ï¼‰
          echo ""
          echo "ğŸ” å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ä¸­..."
          sudo find /var/www/html/storage/framework/sessions -type f -mtime +7 -delete 2>/dev/null
          echo "âœ… å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤å®Œäº†"

          # 4. APTã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
          echo ""
          echo "ğŸ–¥ï¸ APTã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ä¸­..."
          sudo apt-get clean
          echo "âœ… APTã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å®Œäº†"

          # 5. ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ­ã‚°å‰Šé™¤ï¼ˆ7æ—¥ä»¥ä¸Šå‰ï¼‰
          echo ""
          echo "ğŸ“° å¤ã„ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ­ã‚°ã‚’å‰Šé™¤ä¸­..."
          sudo journalctl --vacuum-time=7d 2>/dev/null
          echo "âœ… ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Œäº†"

          # 6. ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†ç”Ÿæˆ
          echo ""
          echo "ğŸ”„ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å†ç”Ÿæˆä¸­..."
          sudo php artisan config:cache
          sudo php artisan route:cache
          sudo php artisan view:cache 2>/dev/null || echo "(view:cacheã‚¹ã‚­ãƒƒãƒ—)"
          echo "âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†ç”Ÿæˆå®Œäº†"

          echo ""
          echo "=========================================="
          echo "=== ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œã®ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨çŠ¶æ³ ==="
          echo "=========================================="
          df -h /

          echo ""
          echo "ğŸ‰ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†ï¼"
        fi

        CLEANUP

        rm deploy_key.pem
        echo "âœ… Workflow completed!"
