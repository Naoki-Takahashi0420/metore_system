name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  EC2_IP: 3.112.39.129

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to EC2
      env:
        EC2_KEY: ${{ secrets.EC2_KEY }}
      run: |
        # Save SSH key
        echo "$EC2_KEY" > key.pem
        chmod 600 key.pem
        
        # Wait for EC2 to be ready
        for i in {1..10}; do
          if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i key.pem ubuntu@$EC2_IP "echo 'Connected'" 2>/dev/null; then
            echo "EC2 is ready"
            break
          fi
          echo "Waiting for EC2... (attempt $i/10)"
          sleep 10
        done
        
        # Deploy application
        ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@$EC2_IP << 'DEPLOY'
        # Install dependencies if not exists
        if ! command -v php &> /dev/null; then
          sudo apt-get update
          sudo apt-get install -y nginx php8.3-fpm php8.3-mysql php8.3-curl php8.3-xml php8.3-mbstring php8.3-zip git unzip
          curl -sS https://getcomposer.org/installer | php
          sudo mv composer.phar /usr/local/bin/composer
        fi
        
        # Deploy Laravel application
        cd /var/www
        sudo rm -rf html
        sudo git clone https://github.com/$GITHUB_REPOSITORY html
        cd html
        
        # Create .env file
        sudo tee .env << 'ENV' > /dev/null
        APP_NAME=Xsyumeno
        APP_ENV=production
        APP_KEY=base64:FhDmJJEPuQPAz6t5HMt6qTVSYLs7pJg7xLDgBEcVHHg=
        APP_DEBUG=false
        APP_URL=http://3.112.39.129
        
        DB_CONNECTION=mysql
        DB_HOST=xsyumeno-db.cbq0ywo44b0p.ap-northeast-1.rds.amazonaws.com
        DB_PORT=3306
        DB_DATABASE=xsyumenodb
        DB_USERNAME=admin
        DB_PASSWORD=Xsyumeno2024#!
        
        LOG_CHANNEL=stack
        
        CACHE_DRIVER=file
        SESSION_DRIVER=file
        QUEUE_CONNECTION=sync
        ENV
        
        # Install dependencies
        sudo composer install --no-dev --optimize-autoloader
        
        # Laravel setup
        sudo php artisan key:generate
        sudo php artisan config:cache
        sudo php artisan route:cache
        sudo php artisan view:cache
        sudo php artisan migrate --force
        
        # Create admin user
        sudo php artisan tinker --execute="
        try {
          \$user = App\Models\User::firstOrCreate(
            ['email' => 'admin@xsyumeno.com'],
            [
              'name' => 'Administrator',
              'password' => Hash::make('password'),
              'role' => 'superadmin',
              'is_active' => true,
              'email_verified_at' => now()
            ]
          );
          echo 'Admin user ready';
        } catch (Exception \$e) {
          echo 'User creation failed: ' . \$e->getMessage();
        }"
        
        # Set permissions
        sudo chown -R www-data:www-data /var/www/html
        sudo chmod -R 755 /var/www/html
        sudo chmod -R 775 /var/www/html/storage /var/www/html/bootstrap/cache
        
        # Configure Nginx
        sudo tee /etc/nginx/sites-available/default << 'NGINX' > /dev/null
        server {
            listen 80 default_server;
            listen [::]:80 default_server;
            
            root /var/www/html/public;
            index index.php index.html;
            
            server_name _;
            
            location / {
                try_files \$uri \$uri/ /index.php?\$query_string;
            }
            
            location ~ \.php$ {
                include snippets/fastcgi-php.conf;
                fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
                fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
                include fastcgi_params;
            }
            
            location ~ /\.ht {
                deny all;
            }
        }
        NGINX
        
        # Restart services
        sudo systemctl restart nginx php8.3-fpm
        
        echo "================================================"
        echo "DEPLOYMENT SUCCESSFUL!"
        echo "Site URL: http://3.112.39.129"
        echo "Admin Login: http://3.112.39.129/admin/login"
        echo "Email: admin@xsyumeno.com"
        echo "Password: password"
        echo "================================================"
        DEPLOY
        
        # Clean up
        rm key.pem