name: Check OTP API Logs

on:
  workflow_dispatch:
    inputs:
      phone:
        description: 'Phone number to check (optional)'
        required: false
        default: ''

jobs:
  check-otp-api:
    runs-on: ubuntu-latest

    steps:
    - name: Check OTP API Request Logs
      env:
        EC2_KEY: ${{ secrets.EC2_KEY }}
        EC2_HOST: 54.64.54.226
        EC2_USER: ubuntu
        PHONE: ${{ github.event.inputs.phone }}
      run: |
        echo "$EC2_KEY" > deploy_key.pem
        chmod 600 deploy_key.pem

        ssh -o StrictHostKeyChecking=no -i deploy_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
        cd /var/www/html

        echo "=== æœ€æ–°ã®OTP API ãƒªã‚¯ã‚¨ã‚¹ãƒˆ (æœ€æ–°20ä»¶) ==="
        sudo grep "POST.*send-otp\|ðŸ”‘.*OTPç”Ÿæˆ\|ðŸ“±.*SMSé€ä¿¡" storage/logs/laravel.log | tail -20

        echo ""
        echo "=== OTPé€ä¿¡ã‚¨ãƒ©ãƒ¼ (æœ€æ–°10ä»¶) ==="
        sudo grep -i "error.*otp\|failed.*otp\|exception.*otp" storage/logs/laravel.log | tail -10

        if [ -n "${PHONE}" ]; then
          echo ""
          echo "=== ${PHONE} ã«é–¢é€£ã™ã‚‹ãƒ­ã‚° (æœ€æ–°20ä»¶) ==="
          sudo grep "${PHONE}" storage/logs/laravel.log | tail -20
        fi

        echo ""
        echo "=== ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ (æœ€æ–°5ä»¶) ==="
        sudo grep "Too many attempts\|Rate limit" storage/logs/laravel.log | tail -5

        echo ""
        echo "=== ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ (æœ€æ–°10ä»¶) ==="
        sudo grep "validation\|Validation" storage/logs/laravel.log | tail -10
        EOF

        rm deploy_key.pem
