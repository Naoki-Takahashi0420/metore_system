name: Check Reminder Duplicates

on:
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
    - name: Check reminder notification duplicates
      env:
        EC2_KEY: ${{ secrets.EC2_KEY }}
        EC2_HOST: 13.158.240.0
        EC2_USER: ubuntu
      run: |
        echo "$EC2_KEY" > deploy_key.pem
        chmod 600 deploy_key.pem

        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=60 -i deploy_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
        cd /var/www/html

        echo "=== リマインダー通知の重複調査 ==="
        echo ""
        echo "【過去7日間のリマインダー通知（タイプ別件数）】"
        sqlite3 database/database.sqlite "SELECT notification_type, COUNT(*) as count FROM notification_logs WHERE created_at >= datetime('now', '-7 days') AND notification_type LIKE '%reminder%' GROUP BY notification_type ORDER BY count DESC;"

        echo ""
        echo "【同じ予約IDに複数回送信されたリマインダー（重複検出）】"
        sqlite3 -header -column database/database.sqlite "SELECT reservation_id, customer_id, COUNT(*) as send_count, GROUP_CONCAT(channel) as channels, GROUP_CONCAT(datetime(created_at, '+9 hours')) as sent_times FROM notification_logs WHERE created_at >= datetime('now', '-7 days') AND notification_type LIKE '%reminder%' GROUP BY reservation_id, customer_id HAVING COUNT(*) > 2 ORDER BY send_count DESC LIMIT 20;"

        echo ""
        echo "【直近のリマインダー通知ログ（最新30件）】"
        sqlite3 -header -column database/database.sqlite "SELECT id, reservation_id, customer_id, store_id, notification_type, channel, status, datetime(created_at, '+9 hours') as jst_time FROM notification_logs WHERE notification_type LIKE '%reminder%' ORDER BY created_at DESC LIMIT 30;"

        echo ""
        echo "【本日のリマインダー送信回数（顧客別）】"
        sqlite3 -header -column database/database.sqlite "SELECT customer_id, COUNT(*) as count FROM notification_logs WHERE date(created_at) = date('now') AND notification_type LIKE '%reminder%' GROUP BY customer_id HAVING COUNT(*) > 2 ORDER BY count DESC LIMIT 20;"

        echo ""
        echo "【cronジョブの確認】"
        sudo crontab -l 2>/dev/null || echo "root crontab empty"
        echo "---"
        sudo crontab -u www-data -l 2>/dev/null || echo "www-data crontab empty"

        echo ""
        echo "【スケジューラーログ（直近）】"
        grep -i "reminder\|schedule" /var/www/html/storage/logs/laravel-$(date +%F).log 2>/dev/null | tail -30 || echo "No scheduler logs found"
        EOF

        rm deploy_key.pem
