# 🚀 実装計画書 - Revision 1
## システム大規模改修プロジェクト
### 作成日: 2025-08-28
### 目標納期: 2025年9月第1週

---

## 📋 実装方針
**基幹システム（Model/Controller）を先に整備し、View層は後から調整する**
- データ構造の一貫性を最優先
- ビジネスロジックの確立後にUI/UXを最適化
- 段階的なリリースによるリスク軽減

---

## 🗓️ フェーズ別実装計画

### **Phase 1: 基盤となる予約・メニュー構造の改修**
**期間**: 3-4日 | **優先度**: 最高 | **ステータス**: 実装中

#### 1.1 メニューテーブルの構造改修
- [ ] MenuCategoryモデルの作成
  - カテゴリー名（ケアコース/水素コース等）
  - 表示順序
  - アクティブフラグ
- [ ] Menuモデルの改修
  - category_id追加
  - base_price（基本料金）とtime_variations（時間別料金）分離
  - is_visible_to_customer（顧客表示フラグ）
  - is_subscription（サブスク用フラグ）
- [ ] マイグレーション作成と実行

#### 1.2 予約フロー改善
- [ ] 既存顧客用トークン生成機能
- [ ] 店舗別予約表示制御（store_exclusive_mode）
- [ ] メニューの条件別表示ロジック
  - 新規客：public_menus
  - 既存客：all_menus
  - カルテ経由：exclusive_menus

#### 1.3 UI/UX改修（Admin側）
- [ ] MenuResourceの階層表示対応
- [ ] カテゴリー管理画面の追加
- [ ] 並び替え機能（drag & drop）

#### 1.4 顧客側予約画面
- [ ] カテゴリー選択 → 時間選択 → 料金表示フロー
- [ ] オプション追加UI
- [ ] 既存顧客認証フロー

---

### **Phase 2: 予約タイムライン・複数ライン機能**
**期間**: 4-5日 | **優先度**: 高 | **ステータス**: 待機中

#### 2.1 データモデル拡張
- [ ] ReservationLineモデル作成
  - line_type（main/sub/staff）
  - machine_id（機材制約）
  - staff_id（スタッフ専用ライン）
- [ ] 予約制約ロジック
  - 新規客：main_lineのみ
  - 既存客：sub_line振り分け可能
  - 機材制限チェック

#### 2.2 タイムラインWidget改修
- [ ] 複数ライン表示対応
- [ ] ドラッグ&ドロップ予約移動
- [ ] モーダルからのカルテ編集
- [ ] 予約枠の統合表示（複数予約→1枠）

#### 2.3 店舗別カスタマイズ
- [ ] 銀座店：シングルライン＋予備
- [ ] 小山/新宿：スタッフ別ライン
- [ ] 機材2台店舗：ダブルライン対応

---

### **Phase 3: カルテ機能の全面改修**
**期間**: 3日 | **優先度**: 高 | **ステータス**: 待機中

#### 3.1 データ構造改善
```php
// CustomerRecord（固定情報）
- customer_id
- address, occupation
- contract_plan
- referral_source

// VisitRecord（来店毎情報）
- visit_date
- staff_id
- treatment_details
- memo
- next_appointment

// SharedData（顧客共有情報）
- vision_before/after
- treatment_strength
- duration
```

#### 3.2 カルテ入力フォーム
- [ ] タブ切り替え（基本情報/来店履歴/共有データ）
- [ ] 自動データ引き継ぎ
- [ ] PDFテンプレート生成
- [ ] 画像アップロード廃止

#### 3.3 統計連携
- [ ] 担当スタッフ記録 → 歩合計算
- [ ] 次回予約率の自動集計
- [ ] 新規/既存の判定ロジック

---

### **Phase 4: LINE連携・通知システム**
**期間**: 5日 | **優先度**: 中 | **ステータス**: 待機中

#### 4.1 LINE構成設計
```
本部LINE（@eye-training-main）
└─ 新規客集客
└─ 初回クーポン配布

店舗LINE（@ginza-eye, @oyama-eye等）
└─ 既存客対応
└─ カルテアクセス
└─ 予約変更/キャンセル
└─ 店舗独自キャンペーン
```

#### 4.2 通知フロー
- [ ] 予約確認：即時SMS
- [ ] リマインド：前日10時
- [ ] フォローアップ：7日後/30日後
- [ ] キャンセル規定：24時間前警告

#### 4.3 LINE連携機能
- [ ] LIFF実装（カルテ閲覧）
- [ ] リッチメニュー設定
- [ ] Webhook処理
- [ ] メッセージテンプレート管理

---

### **Phase 5: 売上管理・統計機能**
**期間**: 3日 | **優先度**: 中 | **ステータス**: 待機中

#### 5.1 売上処理改善
- [ ] 明細自動連動
- [ ] 割引計算ロジック
- [ ] サブスク来店記録（±1円）
- [ ] 決済方法マスタ管理

#### 5.2 統計ダッシュボード
- [ ] 月次レポート生成
- [ ] スタッフ別実績
- [ ] 新規獲得率/リピート率
- [ ] 店舗比較分析

---

### **Phase 6: スタッフ管理・シフト機能**
**期間**: 2日 | **優先度**: 低 | **ステータス**: 待機中

#### 6.1 シフト管理
- [ ] 一括登録UI
- [ ] パターンテンプレート
- [ ] CSV import/export

#### 6.2 勤怠管理
- [ ] 打刻画面
- [ ] 休憩時間記録
- [ ] 給与計算連携

---

### **Phase 7: データ移行・本番展開**
**期間**: 2日 | **優先度**: 最後 | **ステータス**: 待機中

#### 7.1 データ移行
- [ ] カミングスーンAPI接続
- [ ] 顧客データ変換スクリプト
- [ ] 予約データマッピング
- [ ] バックアップ体制

#### 7.2 本番切替
- [ ] DNS切替準備
- [ ] SSL証明書確認
- [ ] 並行運用期間（1週間）
- [ ] ロールバック手順書

---

## 🔧 技術仕様

### 使用技術
- **Backend**: Laravel 11
- **Admin Panel**: Filament 3
- **Database**: SQLite → MySQL（本番）
- **Queue**: Redis + Laravel Horizon
- **SMS**: AWS SNS
- **LINE**: LINE Messaging API + LIFF

### データベース変更
```sql
-- 新規追加テーブル
CREATE TABLE menu_categories (...)
CREATE TABLE reservation_lines (...)
CREATE TABLE customer_records (...)
CREATE TABLE visit_records (...)
CREATE TABLE line_users (...)

-- 既存テーブル改修
ALTER TABLE menus ADD COLUMN category_id ...
ALTER TABLE reservations ADD COLUMN line_id ...
```

---

## 📊 マイルストーン

| 日付 | 達成目標 |
|------|---------|
| 2025-08-31 | Phase 1 完了（メニュー構造改修） |
| 2025-09-04 | Phase 2-3 完了（タイムライン・カルテ） |
| 2025-09-07 | Phase 4-5 完了（LINE・売上管理） |
| 2025-09-10 | Phase 6-7 完了（全機能実装） |
| 2025-09-15 | 本番切替完了 |

---

## ⚠️ リスク管理

### 想定リスク
1. **データ移行の失敗**
   - 対策：段階的移行、バックアップ体制
2. **LINE API制限**
   - 対策：レート制限実装、キューイング
3. **パフォーマンス劣化**
   - 対策：インデックス最適化、キャッシュ活用

### ロールバック計画
- 各Phase完了時にスナップショット作成
- 旧システム並行稼働（最低2週間）
- DNSによる即時切り戻し可能

---

## 📝 変更履歴

| Revision | 日付 | 変更内容 |
|----------|------|----------|
| 1 | 2025-08-28 | 初版作成 |

---

## 👥 ステークホルダー

- **プロジェクトオーナー**: 夢野マーケティング様
- **開発責任者**: 高橋様
- **テスト責任者**: TBD
- **エンドユーザー**: 各店舗スタッフ

---

## 📞 連絡先

技術的な質問：開発チーム
業務要件確認：夢野マーケティング担当者