<!DOCTYPE html>
<html>
<head>
    <title>店舗選択テスト</title>
</head>
<body>
    <h1>店舗選択フローテスト</h1>

    <script>
    // 店舗選択のテスト
    async function testStoreSelection() {
        console.log('店舗選択テストを開始します...');

        try {
            // CSRFトークンを取得
            const response = await fetch('https://reservation.meno-training.com/stores');
            const html = await response.text();

            // CSRFトークンを抽出
            const tokenMatch = html.match(/name="csrf-token" content="([^"]+)"/);
            const csrfToken = tokenMatch ? tokenMatch[1] : null;

            console.log('CSRFトークン:', csrfToken);

            if (!csrfToken) {
                console.error('CSRFトークンが見つかりません');
                return;
            }

            // 店舗選択をシミュレート（店舗ID=1を使用）
            const formData = new FormData();
            formData.append('_token', csrfToken);
            formData.append('store_id', '1');

            console.log('店舗選択リクエストを送信中...');

            const selectionResponse = await fetch('https://reservation.meno-training.com/reservation/store-selection', {
                method: 'POST',
                body: formData,
                redirect: 'manual'
            });

            console.log('レスポンスステータス:', selectionResponse.status);
            console.log('レスポンスヘッダー:', Object.fromEntries(selectionResponse.headers.entries()));

            if (selectionResponse.status === 302) {
                const location = selectionResponse.headers.get('location');
                console.log('リダイレクト先:', location);

                if (location && location.includes('select-category')) {
                    console.log('✅ 成功: カテゴリー選択ページにリダイレクトされました');
                } else {
                    console.log('❌ 異常: 予期しないリダイレクト先です');
                }
            } else {
                console.log('❌ 異常: 302リダイレクトが返されませんでした');
                const text = await selectionResponse.text();
                console.log('レスポンス内容:', text.substring(0, 500));
            }

        } catch (error) {
            console.error('エラーが発生しました:', error);
        }
    }

    // テスト実行
    testStoreSelection();
    </script>
</body>
</html>