# 📅 LINE メッセージタイミング仕様

## ✅ **実装するメッセージ種類（必要最小限）**

### 1️⃣ **予約リマインダー（前日のみ）**
- **送信タイミング**: 予約前日の10:00
- **対象**: 翌日予約がある顧客
- **条件**: 
  - 予約ステータスが `confirmed`（確定）
  - キャンセルされていない
  - LINE登録済み

### 2️⃣ **来店お礼（当日のみ）**  
- **送信タイミング**: 予約終了の2〜3時間後
- **対象**: 実際に来店した顧客
- **条件**:
  - 予約ステータスが `completed`（完了）
  - キャンセルやno-showではない
  - LINE登録済み

### 3️⃣ **新規登録ウェルカム**
- **送信タイミング**: LINE友だち追加の即時
- **対象**: 新規LINE登録顧客
- **内容**: 簡単な挨拶と利用案内

## ❌ **実装しないもの**

- ~~3日前リマインダー~~
- ~~当日朝リマインダー~~  
- ~~アンケート依頼~~
- ~~次回予約案内~~
- ~~定期メンテナンス案内~~
- ~~カムバックキャンペーン~~

## 📊 **ステータス判定ロジック**

```php
// 予約ステータス
'pending'    → 未確定（送信しない）
'confirmed'  → 確定（リマインダー対象）
'completed'  → 完了（お礼メッセージ対象）
'cancelled'  → キャンセル（送信しない）
'no_show'    → 来店なし（送信しない）
```

## ⚙️ **実際の動作フロー**

### 予約リマインダー
```
毎日 10:00
    ↓
翌日の予約を検索
    ↓
ステータス = confirmed のみ
    ↓
LINE送信（失敗時SMS）
```

### 来店お礼
```
30分ごとにチェック
    ↓  
2-3時間前に終了した予約を検索
    ↓
ステータス = completed のみ
    ↓
LINE送信（1回のみ）
```

## 🔧 **設定可能項目**

### 管理画面で変更可能
- リマインダー送信時刻（デフォルト: 10:00）
- お礼メッセージ送信タイミング（2時間後/3時間後/オフ）
- 配信禁止時間帯（22:00-8:00）

### メッセージテンプレート
```
【リマインダー】
{{customer_name}}様
明日 {{start_time}} のご予約をお待ちしております。
場所: {{store_name}}

【お礼】
{{customer_name}}様
本日はご来店ありがとうございました。
またのご利用をお待ちしております。
```

## 📝 **実装コマンド**

```bash
# 前日リマインダー（毎日10:00実行）
php artisan line:send-reminders

# 来店お礼（30分ごと実行）
php artisan line:send-followup

# テスト実行
php artisan line:send-reminders --test
php artisan line:send-followup --test
```

## 🚨 **重要な考慮事項**

1. **ステータス管理が必須**
   - 予約作成時: `pending`
   - スタッフ確認後: `confirmed`
   - 実際に来店: `completed`
   - キャンセル: `cancelled`

2. **二重送信防止**
   - `reminder_sent_at` フィールドで管理
   - `followup_sent_at` フィールドで管理

3. **顧客の意思尊重**
   - `line_notifications_enabled` がfalseなら送信しない
   - ブロック顧客には送信しない

これでシンプルかつ実用的なLINE通知システムになります！