# デバッグプロトコル - 根本原因分析の徹底

## 🚨 過去の失敗から学んだ教訓

### 問題: 対症療法的な修正の繰り返し

**症例**: SQL曖昧性エラー（2025-10-20 〜 2025-10-24）
- 1回目: `select()`を追加 → 一時的に解決したように見えた
- 2回目: 同じ箇所でまたエラー → また`select()`を追加
- 3回目: ようやく根本原因を理解 → `select()`を削除

**損失**:
- 3回のデプロイサイクル
- 本番環境での繰り返しダウンタイム
- ユーザーへの影響

---

## 📋 エラー修正時の必須プロトコル

### Phase 1: 根本原因の理解（必須）

エラー修正を始める前に、**必ず**以下の質問に答える：

```
Claude Code への指示:

「このエラーを修正する前に、以下を必ず調査してください：

1. **根本原因の特定**
   - なぜこのエラーが発生するのか？
   - SQLクエリの実際の実行結果は？
   - どのメソッド/関数の責任範囲か？

2. **再現条件の明確化**
   - 常に発生するのか、条件付きか？
   - 特定のユーザーロール/データ量で発生？
   - キャッシュの影響は？

3. **過去の履歴調査**
   - 同じエラーが過去に発生していないか？
   - 過去の修正は正しかったのか？
   - git log で関連ファイルの変更履歴を確認

4. **複数の解決策の検討**
   - 最低3つの解決案を提示
   - それぞれのメリット/デメリット
   - 推奨案とその理由

上記を全て完了してから修正コードを提示してください。」
```

### Phase 2: 影響範囲の調査（必須）

```
「修正を実装する前に：

1. **同じパターンの検索**
   - コードベース全体で同じ問題がないか grep/Grep
   - 類似のメソッド呼び出しをすべてリスト化

2. **依存関係の確認**
   - この修正が他の機能に影響しないか？
   - 関連するテストケースは？

3. **ロールバック計画**
   - この修正が失敗した場合の戻し方は？
   - 既存のデータへの影響は？」
```

### Phase 3: 修正の検証（必須）

```
「修正実装後、デプロイ前に：

1. **動作説明**
   - 修正前のコードがなぜ失敗したのか説明
   - 修正後のコードがなぜ成功するのか説明
   - SQLクエリレベルでの変化を明示

2. **テストケース**
   - 全ユーザーロールでテスト
   - エッジケースの確認
   - データ量の違いでの確認

3. **ドキュメント化**
   - CLAUDE.md に教訓を追加
   - 再発防止策を明記」
```

---

## 🎯 具体的なプロンプトテンプレート

### エラー発生時に使うプロンプト

```
【緊急】500エラーが発生しています。

以下の手順で対応してください：

## Step 1: 情報収集（15分以内）
1. 本番ログから最新エラー50行を取得
2. エラーメッセージの完全なスタックトレースを確認
3. 関連ファイルのgit履歴を調査（過去1ヶ月）

## Step 2: 根本原因分析（30分以内）
1. なぜこのエラーが発生するのか、技術的な理由を説明
2. 同じエラーが過去に発生していないか確認
3. 過去に修正されていた場合、その修正の妥当性を評価

## Step 3: 解決策の提案（複数案）
1. 最低3つの解決策を提示
2. それぞれのメリット/デメリット/リスクを明記
3. 推奨案を選び、理由を説明

## Step 4: 実装前チェック
1. コードベース全体で同じパターンがないか検索
2. 修正の影響範囲をリスト化
3. ロールバック手順を明記

## Step 5: 実装
1. 修正コードを実装
2. 修正前後のSQL/動作の違いを説明
3. テストすべきケースをリスト化

## Step 6: デプロイ後
1. CLAUDE.md に教訓を追加
2. 再発防止策をドキュメント化

**重要**: Step 1-4を完了するまで、コード修正に着手しないでください。
```

---

## 💡 より深い分析を促すプロンプト

### "Why" を5回繰り返す（5 Whys 手法）

```
「このエラーを修正する前に、5 Whys分析を実施してください：

エラー: SQL曖昧性エラーが発生

1. Why? → storesとstore_managersの両方にidカラムがあるから
2. Why? → manageableStores()がJOINするから
3. Why? → select()でテーブルプレフィックスなしのidを指定したから
4. Why? → pluck()の前にselect()を使う必要があると思ったから
5. Why? → pluck()が自動的にカラムを選択することを知らなかったから

根本原因: pluck()の動作を理解していなかった
真の解決策: select()を削除し、pluck()に任せる」
```

---

## 📚 参考: 良い修正 vs 悪い修正

### ❌ 悪い修正の例

```php
// エラー: ambiguous column name: id
// 悪い修正: select()を追加
return $user->manageableStores()
    ->select('stores.id', 'stores.name')  // ← 対症療法
    ->pluck('name', 'stores.id');

// なぜ悪い？
// - 根本原因（select+pluckの不適切な組み合わせ）を理解していない
// - 一時的に動くが、環境/データ次第で再発する
// - 他の箇所に同じパターンが残る
```

### ✅ 良い修正の例

```php
// エラー: ambiguous column name: id
// 良い修正: select()を削除
return $user->manageableStores()
    ->where('stores.is_active', true)
    ->pluck('stores.name', 'stores.id');  // pluck()が自動選択

// なぜ良い？
// - 根本原因（select不要）を理解している
// - Laravelの仕様通りの書き方
// - 他の箇所も同時に修正
// - ドキュメント化して再発防止
```

---

## 🔧 CLAUDE.md への追加推奨事項

このプロトコルを実践するため、CLAUDE.mdに以下を追加：

```markdown
## 🚨 エラー修正時の必須手順

### エラーが発生したら

1. **このファイルを読む**: `/DEBUGGING-PROTOCOL.md`
2. **プロトコルに従う**: 対症療法を避け、根本原因を追求
3. **5 Whysを実施**: 表面的な原因で満足しない
4. **全体検索**: 同じパターンを全て修正
5. **ドキュメント化**: 教訓をCLAUDE.mdに追加

### 禁止事項

- ❌ エラーログだけ見て即修正
- ❌ 「とりあえず動けばOK」思考
- ❌ 1箇所だけ修正して他を放置
- ❌ 過去の履歴を確認しない
- ❌ ドキュメント化をサボる
```

---

## 📊 効果測定

このプロトコル導入後の目標：

- 同じエラーの再発: **0回**
- 修正の平均成功率: **100%**（1回の修正で完全解決）
- デプロイ後の問題発生率: **<1%**

---

**作成日**: 2025-10-25
**最終更新**: 2025-10-25
**バージョン**: 1.0
