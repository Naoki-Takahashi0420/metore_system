# LINE通知システム設定ガイド

## 📋 概要
本システムでは、各店舗が独自のLINE公式アカウントを使用して顧客への通知を行います。
LINE通知が失敗した場合は自動的にSMS通知に切り替わる仕組みになっています。

## 🔄 通知フローの仕組み

```
[予約作成/変更/キャンセル]
        ↓
[顧客がLINE連携済み？]
   YES ↓        ↓ NO
[LINE通知送信]  [SMS通知送信]
   失敗 ↓
[SMS通知送信]
```

## 📱 LINE設定の手順

### ステップ1: LINE Developersでの準備

1. [LINE Developers Console](https://developers.line.biz/console/)にアクセス
2. 新規プロバイダーを作成（店舗ごとに作成推奨）
3. 「Messaging API」チャネルを作成
4. チャネル基本設定で以下を確認：
   - **Channel Secret**: 基本設定タブで確認
   - **Channel Access Token**: Messaging APIタブで発行（長期トークン推奨）
   - **Bot Basic ID**: チャネル基本設定で確認

### ステップ2: Webhook設定

1. Messaging APIタブで「Webhook URL」を設定：
   ```
   https://your-domain.com/api/line/webhook/{store_code}
   ```
   ※ `{store_code}`は各店舗のコードに置き換え

2. 「Webhookの利用」をONに設定
3. 「応答メッセージ」をOFFに設定（自動応答を無効化）

### ステップ3: システム管理画面での設定

1. 管理画面にログイン
2. 「店舗管理」→対象店舗を選択→「LINE設定」タブ
3. 以下の情報を入力：
   - **LINE連携を有効にする**: ON
   - **Bot Basic ID**: LINE Developersで確認した値
   - **Channel Access Token**: 発行した長期トークン
   - **Channel Secret**: 基本設定で確認した値

### ステップ4: 動作確認

1. テスト用の顧客で予約を作成
2. 予約完了画面でLINE QRコードが表示されることを確認
3. QRコードをスキャンして友だち追加
4. LINE連携完了メッセージが届くことを確認

## 👥 顧客のLINE連携タイミング

### 連携のタイミング
1. **予約完了画面**: 予約完了後に自動表示されるQRコード
2. **有効期限**: QRコード生成から30日間
3. **使用回数**: 1回のみ（セキュリティ対策）

### 連携の流れ
```
[顧客が予約完了]
    ↓
[QRコード表示]
    ↓
[顧客がQRスキャン]
    ↓
[LINE友だち追加]
    ↓
[自動的に顧客情報と紐付け]
    ↓
[連携完了通知送信]
```

## 🔔 通知の種類とタイミング

### 自動送信される通知

| 通知種類 | 送信タイミング | LINE優先 | SMS代替 |
|---------|-------------|---------|---------|
| 予約確認 | 予約完了直後 | ✅ | ✅ |
| リマインダー | 予約前日の指定時刻 | ✅ | ✅ |
| 予約変更 | 変更完了時 | ✅ | ✅ |
| キャンセル確認 | キャンセル時 | ✅ | ✅ |
| フォローアップ | 来店後7/14/30日 | ✅ | ✅ |

### 管理者への通知

| 通知種類 | 送信先 | 方法 |
|---------|-------|-----|
| 新規予約 | 店舗管理者 | メール |
| キャンセル | 店舗管理者 | メール |
| 予約変更 | 店舗管理者 | メール |

## ⚠️ 注意事項

### LINE API利用制限
- **無料プラン**: 月1,000通まで
- **ライトプラン**: 月15,000通まで
- 超過分は従量課金

### Channel Access Tokenの更新
- 最長有効期限: 2年
- 期限切れ前に再発行が必要
- 管理画面から更新可能

### セキュリティ
- Channel SecretとAccess Tokenは厳重に管理
- HTTPSでの通信必須
- Webhook署名検証を実装済み

## 🛠️ トラブルシューティング

### LINE通知が届かない場合

1. **Channel Access Token確認**
   - 有効期限切れでないか
   - 正しくコピーされているか

2. **Webhook設定確認**
   - URLが正しいか
   - Webhookが有効になっているか

3. **顧客のLINE連携状態確認**
   - 管理画面→顧客管理→通知設定で確認
   - LINE連携済みステータスの確認

### SMS通知が届かない場合

1. **AWS認証情報確認**
   - .envファイルのAWS設定
   - SNSの送信制限確認

2. **電話番号形式確認**
   - 国際電話番号形式（+81）に変換されているか

## 📊 利用状況の確認

### 管理画面での確認方法
1. 顧客管理画面で各顧客のLINE連携状態を確認
2. 通知ログで送信成功/失敗を確認

### コマンドラインでの確認
```bash
# LINE連携済み顧客数を確認
php artisan tinker
>>> App\Models\Customer::whereNotNull('line_user_id')->count()

# フォローアップ通知のテスト実行
php artisan notifications:follow-up --days=7 --dry-run
```

## 🚀 ベストプラクティス

1. **段階的な導入**
   - まず1店舗でテスト運用
   - 問題がなければ全店舗展開

2. **メッセージテンプレートの最適化**
   - 顧客名を含める
   - 簡潔で分かりやすい文章
   - 行動を促す内容（CTA）を含める

3. **定期的なメンテナンス**
   - Channel Access Tokenの更新
   - 送信数のモニタリング
   - エラーログの確認

## 📞 サポート

技術的な問題が発生した場合は、以下の情報と共にサポートにお問い合わせください：

- 店舗コード
- エラーメッセージ
- 発生日時
- 実行した操作

---

最終更新日: 2025年9月8日