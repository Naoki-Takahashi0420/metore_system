# 顧客データインポートガイド

## 📊 CSVフィールドマッピング表

| 既存CSV項目 | システムフィールド | 必須 | 変換処理 | 備考 |
|------------|------------------|------|---------|------|
| 顧客番号 | customer_number | ○ | そのまま | ユニークID |
| 顧客名 | last_name, first_name | ○ | スペースで分割 | 姓名を分離 |
| ふりがな | last_name_kana, first_name_kana | - | スペースで分割 | ひらがな→カタカナ変換 |
| メールアドレス | email | - | そのまま | バリデーション必要 |
| 性別 | gender | - | 男性→male, 女性→female | 変換必要 |
| 電話番号1 | phone | ○ | ハイフン除去 | 主電話番号 |
| 電話番号2,3 | notes に追記 | - | 備考欄に記録 | 補助連絡先 |
| 誕生日 | birth_date | - | Y-m-d形式 | 日付フォーマット統一 |
| 郵便番号 | postal_code | - | ハイフン除去 | 7桁数字 |
| 住所 | prefecture, city, address | - | 都道府県を分離 | 住所解析必要 |
| 建物名 | building | - | そのまま | |
| 記念日 | notes に追記 | - | 備考欄に記録 | |
| 顧客特性 | notes に追記 | - | 備考欄に記録 | |
| 来店区分 | notes に追記 | - | 備考欄に記録 | |
| 顧客登録日時 | created_at | - | Y-m-d H:i:s | タイムスタンプ |
| 更新日時 | updated_at | - | Y-m-d H:i:s | タイムスタンプ |

## 📝 CSVテンプレート（推奨フォーマット）

```csv
customer_number,last_name,first_name,last_name_kana,first_name_kana,phone,email,gender,birth_date,postal_code,prefecture,city,address,building,notes,store_id,created_at
127,相川,栄子,アイカワ,エイコ,09056930143,,female,,3230068,栃木県,小山市,下初田１１９８,,"河田、宮本共通の友人",1,2023-06-28 12:34:00
185,相沢,一夫,アイザワ,カズオ,,,male,,3230022,栃木県,小山市,駅東通り2-10-12,グランエスト小山601号室,,1,2023-07-16 11:24:00
```

## 🔄 変換ルール詳細

### 1. 名前の分割
- フルネームの場合：スペースで姓名を分離
- スペースがない場合：最初の2文字を姓、残りを名として扱う
- 例：「相川栄子」→ 姓「相川」、名「栄子」

### 2. 性別の変換
- 「男性」「男」→ "male"
- 「女性」「女」→ "female"
- 「その他」「-」→ "other"
- 空欄 → null

### 3. 電話番号の正規化
- ハイフン、スペース、括弧を除去
- 国番号なしの場合は「0」で開始
- 例：「090-1234-5678」→「09012345678」

### 4. 住所の分離
- 都道府県名を自動検出して分離
- 市区町村も可能な限り分離
- 例：「栃木県小山市下初田１１９８」
  - prefecture: 栃木県
  - city: 小山市
  - address: 下初田１１９８

### 5. 備考欄への統合
複数の項目を備考(notes)に統合：
```
【記念日】10/6
【顧客特性】失客
【来店区分】送付
【補助電話】080-1234-5678
【その他メモ】河田、宮本共通の友人
```

## ⚠️ インポート時の注意事項

### 必須項目
1. **customer_number**：重複不可
2. **phone**：主要連絡先（重複チェックあり）
3. **store_id**：所属店舗（デフォルト設定可能）

### バリデーション
- メールアドレス：RFC準拠の形式チェック
- 電話番号：10-11桁の数字
- 郵便番号：7桁の数字
- 日付：有効な日付形式

### エラー処理
- 重複データ：スキップまたは更新を選択
- 不正データ：エラーログに記録して継続
- 必須項目不足：該当行をスキップ

## 🚀 インポート手順

1. **CSVファイルの準備**
   - UTF-8エンコーディングで保存
   - ヘッダー行を含める
   - カンマ区切り（エクセルからエクスポート可）

2. **管理画面からインポート**
   - 顧客管理 → インポート
   - CSVファイルを選択
   - 店舗を選択（一括設定）
   - プレビュー確認

3. **実行とログ確認**
   - インポート実行
   - 成功/失敗件数の確認
   - エラーログのダウンロード

## 📊 サンプルデータ変換例

### 入力（既存CSV）
```
顧客番号: 127
顧客名: 相川栄子
ふりがな: あいかわえいこ
電話番号1: 090-5693-0143
性別: （空欄）
住所: 栃木県小山市下初田１１９８
```

### 出力（システムフィールド）
```json
{
  "customer_number": "127",
  "last_name": "相川",
  "first_name": "栄子",
  "last_name_kana": "アイカワ",
  "first_name_kana": "エイコ",
  "phone": "09056930143",
  "gender": null,
  "postal_code": "3230068",
  "prefecture": "栃木県",
  "city": "小山市",
  "address": "下初田１１９８",
  "store_id": 1
}
```

## 💡 推奨事項

1. **段階的インポート**
   - まず100件程度でテスト
   - エラーを確認・修正
   - 全データをインポート

2. **バックアップ**
   - インポート前にデータベースバックアップ
   - 元CSVファイルも保管

3. **重複チェック**
   - 電話番号での重複確認
   - 既存顧客は更新または統合

4. **店舗割り当て**
   - CSVに店舗情報がない場合はデフォルト店舗を設定
   - 後から一括変更も可能