# è¦æ³¨æ„é¡§å®¢è‡ªå‹•åˆ¤å®šãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«

## ğŸ“‹ æ¦‚è¦

æ—¢å­˜é¡§å®¢ã«å¯¾ã—ã¦ã€è‡ªå‹•åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ`Customer::evaluateRiskStatus`ï¼‰ã‚’ä¸€æ‹¬é©ç”¨ã—ã€`is_blocked` ã‚’åŒæœŸã™ã‚‹Artisanã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚

## ğŸ¯ ç›®çš„

- **æ—¢å­˜é¡§å®¢ã¸ã®è‡ªå‹•åˆ¤å®šé©ç”¨**: æ–°æ©Ÿèƒ½å°å…¥å‰ã‹ã‚‰å­˜åœ¨ã™ã‚‹é¡§å®¢ã«å¯¾ã—ã¦ã€è‡ªå‹•åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã‚’é©ç”¨
- **æ‰‹å‹•ä¸Šæ›¸ãã®å°Šé‡**: `risk_override=true` ã®é¡§å®¢ã¯æ›´æ–°ã—ãªã„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§è§£é™¤å¯ï¼‰
- **å®‰å…¨ãªä¸€æ‹¬å‡¦ç†**: ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ»ãƒãƒ£ãƒ³ã‚¯å‡¦ç†ãƒ»è©³ç´°ãƒ­ã‚°ã§æœ¬ç•ªã§ã‚‚å®‰å…¨ã«å®Ÿè¡Œ

## ğŸ“¦ ã‚³ãƒãƒ³ãƒ‰

### åŸºæœ¬æ§‹æ–‡

```bash
php artisan customer:risk-backfill [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]
```

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³

| ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | èª¬æ˜ | ä¾‹ |
|----------|------|-----|
| `--dry-run` | å¤‰æ›´ã›ãšé›†è¨ˆãƒ»å‡ºåŠ›ã®ã¿ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ | `--dry-run` |
| `--include-overrides` | `risk_override=true` ã®é¡§å®¢ã‚‚å¯¾è±¡ã«å«ã‚ã‚‹ | `--include-overrides` |
| `--store=ID` | ç‰¹å®šåº—èˆ—ã®é¡§å®¢ã«é™å®š | `--store=1` |
| `--since-days=90` | æœŸé–“ã®ä¸Šæ›¸ãï¼ˆä»»æ„ã€æœªæŒ‡å®šãªã‚‰ config ã®æ—¢å®šã‚’ä½¿ç”¨ï¼‰ | `--since-days=120` |
| `--limit=N` | ä¸Šé™ä»¶æ•°ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰ | `--limit=10` |
| `--only=SOURCE` | `risk_flag_source` ã®çµã‚Šè¾¼ã¿ï¼ˆ`auto` ã¾ãŸã¯ `manual-backfill`ï¼‰ | `--only=auto` |

## ğŸš€ ä½¿ç”¨ä¾‹

### 1. ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆå¿…é ˆã®æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ï¼‰

```bash
# å…¨é¡§å®¢ã§ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³
php artisan customer:risk-backfill --dry-run

# ç‰¹å®šåº—èˆ—ã§ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³
php artisan customer:risk-backfill --dry-run --store=1

# å°‘æ•°ã§ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆãƒ†ã‚¹ãƒˆï¼‰
php artisan customer:risk-backfill --dry-run --limit=10
```

**å‡ºåŠ›ä¾‹**:
```
=== è¦æ³¨æ„é¡§å®¢è‡ªå‹•åˆ¤å®šãƒãƒƒã‚¯ãƒ•ã‚£ãƒ« ===
ãƒ¢ãƒ¼ãƒ‰: ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆå¤‰æ›´ãªã—ï¼‰
å¯¾è±¡é¡§å®¢æ•°: 2524 ä»¶
æ‰‹å‹•ä¸Šæ›¸ãé¡§å®¢: å¯¾è±¡å¤–ï¼ˆrisk_override=false ã®ã¿ï¼‰

[â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“] 100%

=== å®Ÿè¡Œçµæœ ===
å‡¦ç†ä»¶æ•°: 2524 ä»¶
è‡ªå‹•ON (false â†’ true): 17 ä»¶
è‡ªå‹•OFF (true â†’ false): 0 ä»¶
å¤‰æ›´ãªã—: 2507 ä»¶

å®Ÿè¡Œæ™‚é–“: 1.202539 ç§’
â€» ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
```

### 2. æœ¬å®Ÿè¡Œï¼ˆåº—èˆ—ã”ã¨ã«æ®µéšçš„ï¼‰

```bash
# åº—èˆ—1ï¼ˆéŠ€åº§æœ¬åº—ï¼‰ã§æœ¬å®Ÿè¡Œ
php artisan customer:risk-backfill --store=1

# åº—èˆ—2ï¼ˆå°å±±åº—ï¼‰ã§æœ¬å®Ÿè¡Œ
php artisan customer:risk-backfill --store=2
```

### 3. å…¨ä½“é©ç”¨

```bash
# å…¨é¡§å®¢ã§æœ¬å®Ÿè¡Œ
php artisan customer:risk-backfill
```

### 4. æ‰‹å‹•ä¸Šæ›¸ãé¡§å®¢ã‚‚å«ã‚ã¦å¼·åˆ¶åŒæœŸï¼ˆå¿…è¦æ™‚ã®ã¿ï¼‰

```bash
# risk_override=true ã®é¡§å®¢ã‚‚å¯¾è±¡ã«å«ã‚ã‚‹
php artisan customer:risk-backfill --include-overrides
```

âš ï¸ **è­¦å‘Š**: `--include-overrides` ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€æ‰‹å‹•ã§è¨­å®šã—ãŸ `is_blocked` ã®å€¤ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚æœ¬å½“ã«å¿…è¦ãªå ´åˆã®ã¿ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

### 5. æœŸé–“ã®ä¸Šæ›¸ãï¼ˆæ¤œè¨¼ç”¨ï¼‰

```bash
# æœŸé–“ã‚’120æ—¥ã«å¤‰æ›´ã—ã¦ãƒ†ã‚¹ãƒˆ
php artisan customer:risk-backfill --dry-run --since-days=120
```

## ğŸ”§ å‹•ä½œä»•æ§˜

### å¯¾è±¡é¡§å®¢ã®æŠ½å‡º

1. **åŸºæœ¬**: `customers.risk_override = false` ã®é¡§å®¢ã®ã¿
2. **--include-overrides æŒ‡å®šæ™‚**: å…¨é¡§å®¢ãŒå¯¾è±¡
3. **--store æŒ‡å®šæ™‚**: `customers.store_id = æŒ‡å®šåº—èˆ—` ã®é¡§å®¢ã®ã¿
4. **--only æŒ‡å®šæ™‚**: `customers.risk_flag_source = æŒ‡å®šå€¤` ã®é¡§å®¢ã®ã¿

### å‡¦ç†å†…å®¹

1. **ãƒãƒ£ãƒ³ã‚¯å‡¦ç†**: 500ä»¶ãšã¤å®‰å…¨ã«å‡¦ç†ï¼ˆãƒ¡ãƒ¢ãƒªå¯¾ç­–ï¼‰
2. **è‡ªå‹•åˆ¤å®š**: `Customer::evaluateRiskStatus()` ã‚’å„é¡§å®¢ã«é©ç”¨
3. **å¤‰æ›´æ¤œå‡º**: `is_blocked` ã®å¤‰æ›´ã‚’æ¤œå‡ºã—ã¦ãƒ­ã‚°å‡ºåŠ›
4. **ä¾‹å¤–å‡¦ç†**: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç¶™ç¶šå‡¦ç†

### è‡ªå‹•åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

`config/customer_risk.php` ã®é–¾å€¤ã«åŸºã¥ã„ã¦åˆ¤å®š:

| é …ç›® | æœŸé–“ | é–¾å€¤ | é™¤å¤– |
|------|------|------|------|
| ã‚­ãƒ£ãƒ³ã‚»ãƒ« | 90æ—¥ | 2å›ä»¥ä¸Š | `store_fault`, `system_fix` |
| ãƒãƒ¼ã‚·ãƒ§ãƒ¼ | 180æ—¥ | 1å›ä»¥ä¸Š | `store_fault`, `system_fix` |
| äºˆç´„å¤‰æ›´ | 60æ—¥ | 3å›ä»¥ä¸Š | - |

ã„ãšã‚Œã‹1ã¤ã§ã‚‚é–¾å€¤ã‚’è¶…ãˆã‚‹ã¨ `is_blocked = true` ã«ãªã‚Šã¾ã™ã€‚

## ğŸ“Š ãƒ­ã‚°å‡ºåŠ›

### ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›

- å¯¾è±¡é¡§å®¢æ•°
- å‡¦ç†é€²æ—ï¼ˆãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ï¼‰
- å®Ÿè¡Œçµæœã‚µãƒãƒª
  - å‡¦ç†ä»¶æ•°
  - è‡ªå‹•ONä»¶æ•°ï¼ˆfalse â†’ trueï¼‰
  - è‡ªå‹•OFFä»¶æ•°ï¼ˆtrue â†’ falseï¼‰
  - å¤‰æ›´ãªã—ä»¶æ•°
  - ã‚¨ãƒ©ãƒ¼ä»¶æ•°
- å®Ÿè¡Œæ™‚é–“

### ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ã‚°

`storage/logs/laravel-YYYY-MM-DD.log` ã«è©³ç´°ãƒ­ã‚°ã‚’å‡ºåŠ›:

```json
[2025-10-27 23:21:09] local.INFO: [BackfillCustomerRisk] is_blockedå¤‰æ›´ {
  "customer_id": 2592,
  "change": "false â†’ true (è‡ªå‹•ON)",
  "old_blocked": false,
  "new_blocked": true,
  "old_source": null,
  "new_source": "auto",
  "old_flagged_at": null,
  "new_flagged_at": "2025-10-27 23:21:09",
  "dry_run": false
}
```

## âœ… å—ã‘å…¥ã‚ŒåŸºæº–

### ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³
- âœ“ å¤‰æ›´ãŒä¸€åˆ‡ç™ºç”Ÿã—ãªã„
- âœ“ å¯¾è±¡ä»¶æ•°ã¨æƒ³å®šå¤‰æ›´ä»¶æ•°ãŒãƒ­ã‚°ã«è¡¨ç¤ºã•ã‚Œã‚‹
- âœ“ `â€» ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚` ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### æœ¬å®Ÿè¡Œ
- âœ“ `risk_override=false` ã®é¡§å®¢ã®ã¿ `is_blocked` ãŒåŒæœŸã•ã‚Œã‚‹
- âœ“ `risk_override=true` ã®é¡§å®¢ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å¯¾è±¡å¤–
- âœ“ `--include-overrides` æŒ‡å®šæ™‚ã®ã¿æ‰‹å‹•ä¸Šæ›¸ãé¡§å®¢ã‚‚å¯¾è±¡
- âœ“ å¤§é‡ä»¶æ•°ã§ã‚‚ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ/ãƒ¡ãƒ¢ãƒªç•°å¸¸ãªã—ï¼ˆãƒãƒ£ãƒ³ã‚¯å‡¦ç†ï¼‰
- âœ“ å®Ÿè¡Œå¾Œã« `is_blocked`ã€`risk_flag_source`ã€`risk_flagged_at` ãŒæ›´æ–°ã•ã‚Œã‚‹

### ãƒ­ã‚°
- âœ“ å®Ÿè¡Œé–‹å§‹/çµ‚äº†æ™‚åˆ»ãŒãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹
- âœ“ ã‚ªãƒ—ã‚·ãƒ§ãƒ³å†…å®¹ãŒãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹
- âœ“ å¤‰æ›´ã•ã‚ŒãŸé¡§å®¢ã®è©³ç´°ãŒãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹

## ğŸ›¡ï¸ å®‰å…¨æ©Ÿèƒ½

### 1. ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰

```bash
php artisan customer:risk-backfill --dry-run
```

- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä¸€åˆ‡å¤‰æ›´ã—ãªã„
- å®Ÿè¡Œçµæœã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦è¡¨ç¤º
- **å¿…ãšæœ¬å®Ÿè¡Œå‰ã«ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„**

### 2. ãƒãƒ£ãƒ³ã‚¯å‡¦ç†

- 500ä»¶ãšã¤å‡¦ç†ï¼ˆãƒ¡ãƒ¢ãƒªå¯¾ç­–ï¼‰
- `DB::disableQueryLog()` ã§ã‚¯ã‚¨ãƒªãƒ­ã‚°ç„¡åŠ¹åŒ–
- å¤§é‡ãƒ‡ãƒ¼ã‚¿ã§ã‚‚å®‰å…¨ã«å®Ÿè¡Œå¯èƒ½

### 3. ä¾‹å¤–å‡¦ç†

- å€‹åˆ¥é¡§å®¢ã®ã‚¨ãƒ©ãƒ¼ã¯è¨˜éŒ²ã—ã¦ç¶™ç¶š
- ã‚¨ãƒ©ãƒ¼ä»¶æ•°ã‚’æœ€çµ‚ã‚µãƒãƒªã«è¡¨ç¤º
- `storage/logs/laravel.log` ã«è©³ç´°ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°

### 4. ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

æœ¬å®Ÿè¡Œæ™‚ã¯ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™:

```
æœ¬å®Ÿè¡Œã‚’é–‹å§‹ã—ã¾ã™ã€‚2524 ä»¶ã®é¡§å®¢ã‚’å‡¦ç†ã—ã¾ã™ã‹ï¼Ÿ (yes/no) [yes]:
```

è‡ªå‹•å®Ÿè¡Œï¼ˆCI/CDï¼‰ã§ã¯ `--no-interaction` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ :

```bash
php artisan customer:risk-backfill --no-interaction
```

## ğŸ“ é‹ç”¨æ‰‹é †ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—1: äº‹å‰æº–å‚™

```bash
# 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
mysqldump -u username -p database_name > backup.sql

# 2. SQLiteã®å ´åˆ
cp database/database.sqlite database/database.sqlite.backup
```

### ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆå…¨ä½“ï¼‰

```bash
# å…¨é¡§å®¢ã§ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³
php artisan customer:risk-backfill --dry-run

# çµæœã‚’ç¢ºèª
# - å¯¾è±¡é¡§å®¢æ•°
# - è‡ªå‹•ONä»¶æ•°
# - è‡ªå‹•OFFä»¶æ•°
```

### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆåº—èˆ—åˆ¥ï¼‰

```bash
# åº—èˆ—1ã§ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³
php artisan customer:risk-backfill --dry-run --store=1

# åº—èˆ—2ã§ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³
php artisan customer:risk-backfill --dry-run --store=2
```

### ã‚¹ãƒ†ãƒƒãƒ—4: éƒ¨åˆ†é©ç”¨ï¼ˆåº—èˆ—ã”ã¨ã«æ®µéšçš„ï¼‰

```bash
# åº—èˆ—1ã§æœ¬å®Ÿè¡Œ
php artisan customer:risk-backfill --store=1

# çµæœã‚’ç¢ºèªã—ã¦ã‹ã‚‰æ¬¡ã®åº—èˆ—ã¸

# åº—èˆ—2ã§æœ¬å®Ÿè¡Œ
php artisan customer:risk-backfill --store=2
```

### ã‚¹ãƒ†ãƒƒãƒ—5: å…¨ä½“é©ç”¨

```bash
# å…¨é¡§å®¢ã§æœ¬å®Ÿè¡Œ
php artisan customer:risk-backfill
```

### ã‚¹ãƒ†ãƒƒãƒ—6: çµæœç¢ºèª

```bash
# is_blocked=true ã«ãªã£ãŸé¡§å®¢ã‚’ç¢ºèª
sqlite3 database/database.sqlite "
  SELECT id, cancellation_count, no_show_count, is_blocked,
         risk_flag_source, risk_flagged_at
  FROM customers
  WHERE is_blocked = 1
  LIMIT 10;
"

# ãƒ­ã‚°ç¢ºèª
tail -50 storage/logs/laravel-$(date +%Y-%m-%d).log | grep BackfillCustomerRisk
```

## âš ï¸ æ³¨æ„äº‹é …

### 1. æ‰‹å‹•ä¸Šæ›¸ãã®å°Šé‡

- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ `risk_override=true` ã®é¡§å®¢ã¯å¯¾è±¡å¤–
- æ‰‹å‹•ã§è¨­å®šã—ãŸ `is_blocked` ã®å€¤ã‚’ä¿è­·
- `--include-overrides` ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯æ…é‡ã«åˆ¤æ–­

### 2. æœŸé–“ã®ä¸Šæ›¸ã

- `--since-days` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ä¸€æ™‚çš„ãªä¸Šæ›¸ã
- `config/customer_risk.php` ã®è¨­å®šã¯å¤‰æ›´ã•ã‚Œãªã„
- æ¤œè¨¼ç›®çš„ã§ã®ã¿ä½¿ç”¨æ¨å¥¨

### 3. å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°

- å–¶æ¥­æ™‚é–“å¤–ã®å®Ÿè¡Œã‚’æ¨å¥¨
- å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®å ´åˆã¯æ•°åˆ†ã‹ã‹ã‚‹å¯èƒ½æ€§ã‚ã‚Š
- æœ¬ç•ªå®Ÿè¡Œå‰ã«å¿…ãšãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ã§ç¢ºèª

### 4. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

ã‚‚ã—èª¤ã£ã¦å®Ÿè¡Œã—ãŸå ´åˆ:

```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒï¼ˆSQLiteï¼‰
cp database/database.sqlite.backup database/database.sqlite

# ã¾ãŸã¯æ‰‹å‹•ã§ãƒªã‚»ãƒƒãƒˆï¼ˆç‰¹å®šé¡§å®¢ï¼‰
UPDATE customers
SET is_blocked = 0,
    risk_flag_source = NULL,
    risk_flag_reason = NULL,
    risk_flagged_at = NULL
WHERE risk_flag_source = 'auto';
```

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Q1: å¯¾è±¡é¡§å®¢ãŒ0ä»¶ã¨è¡¨ç¤ºã•ã‚Œã‚‹

**åŸå› **: å…¨é¡§å®¢ãŒ `risk_override=true` ã«ãªã£ã¦ã„ã‚‹

**è§£æ±ºç­–**:
```bash
# ç¢ºèª
sqlite3 database/database.sqlite "
  SELECT COUNT(*) as total,
         SUM(CASE WHEN risk_override = 1 THEN 1 ELSE 0 END) as override_true
  FROM customers;
"

# å¿…è¦ã«å¿œã˜ã¦ --include-overrides ã‚’ä½¿ç”¨
php artisan customer:risk-backfill --dry-run --include-overrides
```

### Q2: ãƒ¡ãƒ¢ãƒªä¸è¶³ã‚¨ãƒ©ãƒ¼

**åŸå› **: å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†æ™‚ã®ãƒ¡ãƒ¢ãƒªä¸è¶³

**è§£æ±ºç­–**:
```bash
# PHP ãƒ¡ãƒ¢ãƒªä¸Šé™ã‚’ä¸€æ™‚çš„ã«å¢—ã‚„ã™
php -d memory_limit=512M artisan customer:risk-backfill
```

### Q3: å®Ÿè¡ŒãŒé…ã„

**åŸå› **: é¡§å®¢æ•°ãŒå¤šã„ã€ã¾ãŸã¯DBã‚¯ã‚¨ãƒªãŒé…ã„

**è§£æ±ºç­–**:
```bash
# åº—èˆ—åˆ¥ã«åˆ†ã‘ã¦å®Ÿè¡Œ
php artisan customer:risk-backfill --store=1
php artisan customer:risk-backfill --store=2

# ã¾ãŸã¯ limit ã§åˆ†å‰²å®Ÿè¡Œï¼ˆéæ¨å¥¨ï¼‰
php artisan customer:risk-backfill --limit=500
```

## ğŸ“š é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

### ã‚³ãƒãƒ³ãƒ‰å®Ÿè£…

- `app/Console/Commands/BackfillCustomerRisk.php` - ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«ã‚³ãƒãƒ³ãƒ‰

### è‡ªå‹•åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

- `app/Models/Customer.php` - `evaluateRiskStatus()`, `getRecentReservations()`
- `config/customer_risk.php` - é–¾å€¤ã¨é™¤å¤–ç†ç”±ã®è¨­å®š

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- `CUSTOMER_RISK_IMPLEMENTATION.md` - è‡ªå‹•åˆ¤å®šæ©Ÿèƒ½ã®å®Ÿè£…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- `CUSTOMER_RISK_BACKFILL.md` - ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

## ğŸ“Š å®Ÿè¡Œä¾‹ï¼ˆå®Ÿéš›ã®çµæœï¼‰

### ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®å®Ÿè¡Œçµæœ

```bash
$ php artisan customer:risk-backfill --dry-run

=== è¦æ³¨æ„é¡§å®¢è‡ªå‹•åˆ¤å®šãƒãƒƒã‚¯ãƒ•ã‚£ãƒ« ===
ãƒ¢ãƒ¼ãƒ‰: ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆå¤‰æ›´ãªã—ï¼‰
å¯¾è±¡é¡§å®¢æ•°: 2524 ä»¶
æ‰‹å‹•ä¸Šæ›¸ãé¡§å®¢: å¯¾è±¡å¤–ï¼ˆrisk_override=false ã®ã¿ï¼‰

 2524/2524 [â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“] 100%

=== å®Ÿè¡Œçµæœ ===
å‡¦ç†ä»¶æ•°: 2524 ä»¶
è‡ªå‹•ON (false â†’ true): 17 ä»¶
è‡ªå‹•OFF (true â†’ false): 0 ä»¶
å¤‰æ›´ãªã—: 2507 ä»¶

å®Ÿè¡Œæ™‚é–“: 1.202539 ç§’
â€» ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
```

### æœ¬å®Ÿè¡Œã®çµæœ

```bash
$ php artisan customer:risk-backfill

=== è¦æ³¨æ„é¡§å®¢è‡ªå‹•åˆ¤å®šãƒãƒƒã‚¯ãƒ•ã‚£ãƒ« ===
ãƒ¢ãƒ¼ãƒ‰: æœ¬å®Ÿè¡Œ
å¯¾è±¡é¡§å®¢æ•°: 2524 ä»¶
æ‰‹å‹•ä¸Šæ›¸ãé¡§å®¢: å¯¾è±¡å¤–ï¼ˆrisk_override=false ã®ã¿ï¼‰

æœ¬å®Ÿè¡Œã‚’é–‹å§‹ã—ã¾ã™ã€‚2524 ä»¶ã®é¡§å®¢ã‚’å‡¦ç†ã—ã¾ã™ã‹ï¼Ÿ (yes/no) [yes]:
> yes

 2524/2524 [â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“] 100%

=== å®Ÿè¡Œçµæœ ===
å‡¦ç†ä»¶æ•°: 2524 ä»¶
è‡ªå‹•ON (false â†’ true): 17 ä»¶
è‡ªå‹•OFF (true â†’ false): 0 ä»¶
å¤‰æ›´ãªã—: 2507 ä»¶

å®Ÿè¡Œæ™‚é–“: 1.156838 ç§’
âœ“ is_blocked ã®åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸã€‚
```

### å¤‰æ›´ã•ã‚ŒãŸé¡§å®¢ã®ä¾‹

```bash
$ sqlite3 database/database.sqlite "
  SELECT id, cancellation_count, is_blocked, risk_flag_source
  FROM customers
  WHERE is_blocked = 1
  LIMIT 5;
"

2592|15|1|auto
3469|12|1|auto
2834|8|1|auto
2946|6|1|auto
3673|4|1|auto
```

---

**å®Ÿè£…æ—¥**: 2025-10-27
**æœ€çµ‚æ›´æ–°**: 2025-10-27
**å®Ÿè£…è€…**: Claude Code
