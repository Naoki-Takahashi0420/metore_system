<!DOCTYPE html>
<html>
<head>
    <title>5æ—¥é–“åˆ¶é™ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        button { padding: 10px 20px; margin: 5px; background: #28a745; color: white; border: none; cursor: pointer; }
        .result { margin-top: 10px; padding: 10px; background: #f5f5f5; font-family: monospace; white-space: pre-wrap; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #28a745; color: white; }
        .available { background: #d4edda; color: #155724; }
        .unavailable { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>ğŸ§ª 5æ—¥é–“åˆ¶é™ å®Œå…¨ãƒ†ã‚¹ãƒˆ</h1>

    <div class="section">
        <h2>ãƒ†ã‚¹ãƒˆè¨­å®š</h2>
        <p><strong>é¡§å®¢ID:</strong> 2 (é«˜æ©‹ ç›´å¸Œ)</p>
        <p><strong>æ—¢å­˜äºˆç´„:</strong> 2025-09-17, 2025-09-19</p>
        <p><strong>5æ—¥é–“åˆ¶é™ãƒ«ãƒ¼ãƒ«:</strong> æ—¢å­˜äºˆç´„ã‹ã‚‰å‰å¾Œ5æ—¥é–“ã¯äºˆç´„ä¸å¯ï¼ˆ6æ—¥ç›®ã‹ã‚‰äºˆç´„å¯èƒ½ï¼‰</p>
        <p><strong>æœŸå¾…çµæœ:</strong></p>
        <ul>
            <li>9æœˆ12-16æ—¥: â—‹ (9/17ã‹ã‚‰6æ—¥ä»¥ä¸Šå‰)</li>
            <li>9æœˆ17æ—¥: Ã— (æ—¢å­˜äºˆç´„)</li>
            <li>9æœˆ18æ—¥: Ã— (9/17ã‹ã‚‰1æ—¥å¾Œ, 9/19ã‹ã‚‰1æ—¥å‰)</li>
            <li>9æœˆ19æ—¥: Ã— (æ—¢å­˜äºˆç´„)</li>
            <li>9æœˆ20-24æ—¥: Ã— (9/19ã‹ã‚‰1-5æ—¥å¾Œ)</li>
            <li>9æœˆ25æ—¥ä»¥é™: â—‹ (9/19ã‹ã‚‰6æ—¥ä»¥ä¸Šå¾Œ)</li>
        </ul>
    </div>

    <div class="section">
        <h2>APIç›´æ¥ãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testAllDates()">å…¨æ—¥ç¨‹ã‚’ãƒ†ã‚¹ãƒˆ</button>
        <div id="test-results" class="result"></div>
    </div>

    <div class="section">
        <h2>JavaScriptè¨ˆç®— vs ã‚µãƒ¼ãƒãƒ¼è¨ˆç®—</h2>
        <button onclick="compareCalculations()">è¨ˆç®—æ–¹æ³•ã‚’æ¯”è¼ƒ</button>
        <div id="comparison-results" class="result"></div>
    </div>

    <script>
        async function testAllDates() {
            const resultDiv = document.getElementById('test-results');
            resultDiv.textContent = 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n\n';

            const testDates = [
                '2025-09-12', '2025-09-13', '2025-09-14', '2025-09-15', '2025-09-16',
                '2025-09-17', '2025-09-18', '2025-09-19', '2025-09-20', '2025-09-21',
                '2025-09-22', '2025-09-23', '2025-09-24', '2025-09-25', '2025-09-26',
                '2025-09-27', '2025-09-28', '2025-09-29', '2025-09-30', '2025-10-01'
            ];

            const existingDates = ['2025-09-17', '2025-09-19'];

            let html = '<table>';
            html += '<tr><th>æ—¥ä»˜</th><th>æœŸå¾…å€¤</th><th>APIçµæœ</th><th>ç†ç”±</th><th>åˆ¤å®š</th></tr>';

            for (const date of testDates) {
                // JavaScriptè¨ˆç®—
                const expectedAvailable = isDateExpectedAvailable(date, existingDates);

                try {
                    // APIå‘¼ã³å‡ºã—
                    const response = await fetch('/api/check-availability', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            store_id: 1,
                            menu_id: 26,  // æ°´ç´ ã‚µãƒ–ã‚¹ã‚¯ãƒ—ãƒ©ãƒ³
                            customer_id: 2,
                            date: date,
                            time: '10:00'
                        })
                    });

                    const data = await response.json();
                    const apiAvailable = data.available;
                    const isCorrect = expectedAvailable === apiAvailable;

                    const reason = getReason(date, existingDates);

                    html += `<tr class="${isCorrect ? 'available' : 'unavailable'}">`;
                    html += `<td>${date}</td>`;
                    html += `<td>${expectedAvailable ? 'â—‹' : 'Ã—'}</td>`;
                    html += `<td>${apiAvailable ? 'â—‹' : 'Ã—'}</td>`;
                    html += `<td>${reason}</td>`;
                    html += `<td>${isCorrect ? 'âœ…' : 'âŒ'}</td>`;
                    html += '</tr>';

                } catch (error) {
                    html += `<tr class="unavailable">`;
                    html += `<td>${date}</td>`;
                    html += `<td>-</td>`;
                    html += `<td colspan="3">ã‚¨ãƒ©ãƒ¼: ${error.message}</td>`;
                    html += '</tr>';
                }

                // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’é¿ã‘ã‚‹ãŸã‚å°‘ã—å¾…æ©Ÿ
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            html += '</table>';
            resultDiv.innerHTML = html;
        }

        function isDateExpectedAvailable(targetDate, existingDates) {
            const target = new Date(targetDate + 'T00:00:00');

            for (const existingDateStr of existingDates) {
                const existing = new Date(existingDateStr + 'T00:00:00');
                const daysDiff = Math.abs((target - existing) / (24 * 60 * 60 * 1000));

                // 5æ—¥é–“åˆ¶é™: 6æ—¥æœªæº€ã®å ´åˆã¯äºˆç´„ä¸å¯
                if (daysDiff < 6) {
                    return false;
                }
            }

            return true;
        }

        function getReason(targetDate, existingDates) {
            if (existingDates.includes(targetDate)) {
                return 'æ—¢å­˜äºˆç´„æ—¥';
            }

            const target = new Date(targetDate + 'T00:00:00');
            let minDays = Infinity;
            let closestDate = '';

            for (const existingDateStr of existingDates) {
                const existing = new Date(existingDateStr + 'T00:00:00');
                const daysDiff = Math.abs((target - existing) / (24 * 60 * 60 * 1000));

                if (daysDiff < minDays) {
                    minDays = daysDiff;
                    closestDate = existingDateStr;
                }
            }

            if (minDays < 6) {
                return `${closestDate}ã‹ã‚‰${minDays}æ—¥å¾Œ`;
            } else {
                return `${closestDate}ã‹ã‚‰${minDays}æ—¥å¾Œï¼ˆäºˆç´„å¯èƒ½ï¼‰`;
            }
        }

        function compareCalculations() {
            const resultDiv = document.getElementById('comparison-results');

            const testCases = [
                { target: '2025-09-17', existing: '2025-09-17' },  // åŒæ—¥
                { target: '2025-09-24', existing: '2025-09-19' },  // 5æ—¥å¾Œ
                { target: '2025-09-25', existing: '2025-09-19' },  // 6æ—¥å¾Œ
                { target: '2025-09-12', existing: '2025-09-17' },  // 5æ—¥å‰
                { target: '2025-09-11', existing: '2025-09-17' },  // 6æ—¥å‰
            ];

            let result = '=== JavaScript vs ã‚µãƒ¼ãƒãƒ¼è¨ˆç®— ===\n\n';

            for (const testCase of testCases) {
                const targetDate = new Date(testCase.target + 'T00:00:00');
                const existingDate = new Date(testCase.existing + 'T00:00:00');

                // JavaScriptè¨ˆç®—
                const jsTimeDiff = targetDate - existingDate;
                const jsDaysDiff = jsTimeDiff / (24 * 60 * 60 * 1000);
                const jsAbsDaysDiff = Math.abs(jsDaysDiff);
                const jsAvailable = jsAbsDaysDiff >= 6;

                // Carbonè¨ˆç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç¬¦å·ä»˜ãï¼‰
                const carbonDaysDiff = jsDaysDiff;  // åŒã˜è¨ˆç®—
                const carbonAbsDaysDiff = Math.abs(carbonDaysDiff);
                const carbonAvailable = carbonAbsDaysDiff >= 6;

                result += `${testCase.target} vs ${testCase.existing}:\n`;
                result += `  æ—¥æ•°å·®: ${jsDaysDiff} (çµ¶å¯¾å€¤: ${jsAbsDaysDiff})\n`;
                result += `  äºˆç´„å¯èƒ½: ${jsAvailable ? 'Yes' : 'No'}\n`;
                result += `  åˆ¶é™ãƒã‚§ãƒƒã‚¯: abs(${carbonDaysDiff}) < 6 = ${carbonAbsDaysDiff < 6}\n\n`;
            }

            resultDiv.textContent = result;
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
        window.addEventListener('load', () => {
            compareCalculations();
        });
    </script>
</body>
</html>