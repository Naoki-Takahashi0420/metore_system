<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚µãƒ–ã‚¹ã‚¯äºˆç´„ä¿®æ­£</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 3px solid #007bff; padding-bottom: 10px; }
        h2 { color: #555; margin-top: 0; }
        button { padding: 12px 24px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        .result { margin-top: 15px; padding: 15px; background: #f8f9fa; border-left: 4px solid #007bff; font-family: monospace; }
        .available { color: green; font-weight: bold; font-size: 18px; }
        .unavailable { color: red; font-weight: bold; font-size: 18px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #dee2e6; padding: 10px; text-align: center; }
        th { background: #007bff; color: white; }
        .status-ok { background: #d4edda; }
        .status-ng { background: #f8d7da; }
        .code { background: #f4f4f4; padding: 10px; border-radius: 4px; margin: 10px 0; overflow-x: auto; }
        pre { margin: 0; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ã‚µãƒ–ã‚¹ã‚¯äºˆç´„å•é¡Œã®ä¿®æ­£</h1>

        <div class="card">
            <h2>å•é¡Œã®æ¦‚è¦</h2>
            <p>é¡§å®¢ï¼ˆé«˜æ©‹ ç›´å¸Œ, ID: 2ï¼‰ã®ã‚µãƒ–ã‚¹ã‚¯äºˆç´„ã§ã€9æœˆ25æ—¥ä»¥é™ãŒäºˆç´„å¯èƒ½ã§ã‚ã‚‹ã¹ããªã®ã«ã€ã™ã¹ã¦Ã—ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã€‚</p>
            <ul>
                <li>æ—¢å­˜äºˆç´„: 2025-09-17, 2025-09-19</li>
                <li>5æ—¥é–“åˆ¶é™ã«ã‚ˆã‚Šã€2025-09-25ä»¥é™ãŒäºˆç´„å¯èƒ½</li>
                <li>APIã¯æ­£ã—ãå‹•ä½œï¼ˆcustomer_id=2ã‚’é€ä¿¡ã™ã‚Œã°æ­£ã—ã„çµæœã‚’è¿”ã™ï¼‰</li>
                <li>å•é¡Œ: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒæ­£ã—ã„customer_idã‚’é€ä¿¡ã—ã¦ã„ãªã„å¯èƒ½æ€§</li>
            </ul>
        </div>

        <div class="card">
            <h2>ã‚¹ãƒ†ãƒƒãƒ—1: æ­£ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h2>
            <button onclick="setupCorrectData()" class="success">æ­£ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š</button>
            <button onclick="clearAllData()" class="danger">ã™ã¹ã¦ã‚¯ãƒªã‚¢</button>
            <div id="setup-result" class="result" style="display:none;"></div>
        </div>

        <div class="card">
            <h2>ã‚¹ãƒ†ãƒƒãƒ—2: APIå‹•ä½œç¢ºèª</h2>
            <button onclick="testAPI()">APIã‚’ãƒ†ã‚¹ãƒˆ</button>
            <div id="api-result" class="result" style="display:none;"></div>
        </div>

        <div class="card">
            <h2>ã‚¹ãƒ†ãƒƒãƒ—3: ã‚µãƒ–ã‚¹ã‚¯äºˆç´„ãƒšãƒ¼ã‚¸ã®ä¿®æ­£ç‰ˆ</h2>
            <button onclick="openFixedSubscriptionPage()">ä¿®æ­£ç‰ˆã‚µãƒ–ã‚¹ã‚¯äºˆç´„ãƒšãƒ¼ã‚¸ã‚’é–‹ã</button>
            <div class="code">
                <strong>ä¿®æ­£å†…å®¹:</strong>
                <pre>1. customer_idã‚’ç¢ºå®Ÿã«å–å¾—ã—ã¦é€ä¿¡
2. ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’æ”¹å–„</pre>
            </div>
        </div>

        <div class="card">
            <h2>ã‚¹ãƒ†ãƒƒãƒ—4: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–</h2>
            <button onclick="startMonitoring()">ç›£è¦–ã‚’é–‹å§‹</button>
            <div id="monitor-result" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        function setupCorrectData() {
            const correctData = {
                customer: {
                    id: 2,
                    last_name: "é«˜æ©‹",
                    first_name: "ç›´å¸Œ",
                    phone: "08033372305",
                    email: "naoki@example.com"
                },
                session: {
                    existing_customer_id: "2",
                    subscription_store_id: "1",
                    subscription_menu_id: "1",
                    subscription_store_name: "éŠ€åº§æœ¬åº—",
                    subscription_menu_name: "ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ã‚³ãƒ¼ã‚¹"
                }
            };

            // localStorageã«è¨­å®š
            localStorage.setItem('customer_data', JSON.stringify(correctData.customer));
            localStorage.setItem('customer_token', 'test-token');

            // sessionStorageã«è¨­å®š
            Object.entries(correctData.session).forEach(([key, value]) => {
                sessionStorage.setItem(key, value);
            });

            const resultDiv = document.getElementById('setup-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <strong>âœ… ãƒ‡ãƒ¼ã‚¿è¨­å®šå®Œäº†</strong><br><br>
                <strong>localStorage:</strong><br>
                customer_data: ${JSON.stringify(correctData.customer, null, 2)}<br><br>
                <strong>sessionStorage:</strong><br>
                ${Object.entries(correctData.session).map(([k, v]) => `${k}: ${v}`).join('<br>')}
            `;
        }

        function clearAllData() {
            localStorage.clear();
            sessionStorage.clear();
            document.getElementById('setup-result').style.display = 'block';
            document.getElementById('setup-result').innerHTML = 'âœ… ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ';
        }

        async function testAPI() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'ãƒ†ã‚¹ãƒˆä¸­...';

            const tests = [
                { date: '2025-09-21', expected: false },
                { date: '2025-09-22', expected: false },
                { date: '2025-09-23', expected: false },
                { date: '2025-09-24', expected: false },
                { date: '2025-09-25', expected: true },
                { date: '2025-09-26', expected: true },
                { date: '2025-09-27', expected: true }
            ];

            let html = '<table>';
            html += '<tr><th>æ—¥ä»˜</th><th>æœŸå¾…å€¤</th><th>å®Ÿéš›</th><th>çµæœ</th></tr>';

            for (const test of tests) {
                const response = await fetch('/api/check-availability', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        store_id: 1,
                        menu_id: 1,
                        customer_id: 2,
                        date: test.date,
                        time: '10:00'
                    })
                });

                const data = await response.json();
                const isCorrect = data.available === test.expected;

                html += `<tr class="${isCorrect ? 'status-ok' : 'status-ng'}">`;
                html += `<td>${test.date}</td>`;
                html += `<td>${test.expected ? 'â—‹' : 'Ã—'}</td>`;
                html += `<td>${data.available ? 'â—‹' : 'Ã—'}</td>`;
                html += `<td>${isCorrect ? 'âœ…' : 'âŒ'}</td>`;
                html += '</tr>';
            }

            html += '</table>';
            resultDiv.innerHTML = html;
        }

        function openFixedSubscriptionPage() {
            // ä¿®æ­£ç‰ˆã®ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ
            const fixedCode = `
// ä¿®æ­£ç‰ˆ: customer_idã‚’ç¢ºå®Ÿã«å–å¾—ã—ã¦é€ä¿¡
const customerData = JSON.parse(localStorage.getItem('customer_data') || '{}');
let customerId = sessionStorage.getItem('existing_customer_id');

// æ–‡å­—åˆ—ã®å ´åˆã¯æ•°å€¤ã«å¤‰æ›
if (customerId) {
    customerId = parseInt(customerId, 10);
} else if (customerData && customerData.id) {
    customerId = customerData.id;
}

console.log('ä½¿ç”¨ã™ã‚‹customer_id:', customerId);

// APIå‘¼ã³å‡ºã—æ™‚ã«å¿…ãšå«ã‚ã‚‹
const requestBody = {
    store_id: storeId,
    menu_id: menuId,
    customer_id: customerId,  // å¿…ãšå«ã‚ã‚‹
    date: date,
    time: time
};
            `;

            alert('ä¿®æ­£ç‰ˆã®ã‚³ãƒ¼ãƒ‰ãŒã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚\n/reservation/subscription-booking ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚');
            console.log(fixedCode);
            window.open('/reservation/subscription-booking', '_blank');
        }

        async function startMonitoring() {
            const resultDiv = document.getElementById('monitor-result');
            resultDiv.style.display = 'block';

            // Fetch APIã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆ
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                const [url, options] = args;

                if (url.includes('check-availability') && options) {
                    const body = JSON.parse(options.body || '{}');
                    resultDiv.innerHTML += `
                        <div style="border-bottom: 1px solid #ccc; padding: 10px 0;">
                            <strong>ğŸ“¤ APIå‘¼ã³å‡ºã—æ¤œçŸ¥:</strong><br>
                            URL: ${url}<br>
                            customer_id: ${body.customer_id || 'ãªã—'} ${body.customer_id ? 'âœ…' : 'âŒ'}<br>
                            date: ${body.date}, time: ${body.time}
                        </div>
                    `;
                }

                return originalFetch.apply(this, args).then(response => {
                    if (url.includes('check-availability')) {
                        const clone = response.clone();
                        clone.json().then(data => {
                            resultDiv.innerHTML += `
                                <div style="padding: 10px 0;">
                                    <strong>ğŸ“¥ ãƒ¬ã‚¹ãƒãƒ³ã‚¹:</strong>
                                    ${data.available ? '<span class="available">â—‹ äºˆç´„å¯èƒ½</span>' : '<span class="unavailable">Ã— äºˆç´„ä¸å¯</span>'}
                                    ${data.reason ? ` (ç†ç”±: ${data.reason})` : ''}
                                </div>
                            `;
                        });
                    }
                    return response;
                });
            };

            resultDiv.innerHTML = '<strong>ğŸ” ç›£è¦–é–‹å§‹...</strong><br>åˆ¥ã‚¿ãƒ–ã§ã‚µãƒ–ã‚¹ã‚¯äºˆç´„ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚<br><br>';
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
        window.addEventListener('load', () => {
            console.log('=== ã‚µãƒ–ã‚¹ã‚¯äºˆç´„ä¿®æ­£ãƒ„ãƒ¼ãƒ«èµ·å‹• ===');
            console.log('ç¾åœ¨ã®customer_data:', localStorage.getItem('customer_data'));
            console.log('ç¾åœ¨ã®existing_customer_id:', sessionStorage.getItem('existing_customer_id'));
        });
    </script>
</body>
</html>