<!DOCTYPE html>
<html>
<head>
    <title>ã‚µãƒ–ã‚¹ã‚¯äºˆç´„ãƒ‡ãƒãƒƒã‚°</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #444; background: #2d2d30; }
        h2 { color: #4ec9b0; }
        .success { color: #6a9955; }
        .error { color: #f48771; }
        .warning { color: #dcdcaa; }
        .info { color: #9cdcfe; }
        button { padding: 10px; margin: 5px; background: #007acc; color: white; border: none; cursor: pointer; }
        button:hover { background: #005a9e; }
        pre { background: #1e1e1e; padding: 10px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #444; padding: 8px; text-align: left; }
        th { background: #007acc; color: white; }
    </style>
</head>
<body>
    <h1 style="color: #4ec9b0;">ğŸ” ã‚µãƒ–ã‚¹ã‚¯äºˆç´„ å®Œå…¨ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>

    <div class="section">
        <h2>1. ç’°å¢ƒãƒã‚§ãƒƒã‚¯</h2>
        <button onclick="checkEnvironment()">ç’°å¢ƒã‚’ç¢ºèª</button>
        <pre id="env-result"></pre>
    </div>

    <div class="section">
        <h2>2. é¡§å®¢ãƒ‡ãƒ¼ã‚¿ç¢ºèª</h2>
        <button onclick="checkCustomerData()">é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª</button>
        <pre id="customer-result"></pre>
    </div>

    <div class="section">
        <h2>3. APIç›´æ¥ãƒ†ã‚¹ãƒˆï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰</h2>
        <button onclick="testAPIPatterns()">APIãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ</button>
        <pre id="api-result"></pre>
    </div>

    <div class="section">
        <h2>4. ã‚µãƒ–ã‚¹ã‚¯äºˆç´„ãƒšãƒ¼ã‚¸ã®å‹•ä½œç¢ºèª</h2>
        <button onclick="simulateSubscriptionPage()">ãƒšãƒ¼ã‚¸å‹•ä½œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ</button>
        <pre id="simulation-result"></pre>
    </div>

    <div class="section">
        <h2>5. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç›£è¦–</h2>
        <button onclick="startNetworkMonitor()">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç›£è¦–é–‹å§‹</button>
        <button onclick="window.open('/reservation/subscription-booking', '_blank')">ã‚µãƒ–ã‚¹ã‚¯äºˆç´„ãƒšãƒ¼ã‚¸ã‚’é–‹ãï¼ˆåˆ¥ã‚¿ãƒ–ï¼‰</button>
        <pre id="network-result"></pre>
    </div>

    <script>
        const log = (target, message, type = 'info') => {
            const colors = {
                success: '#6a9955',
                error: '#f48771',
                warning: '#dcdcaa',
                info: '#9cdcfe'
            };
            const timestamp = new Date().toLocaleTimeString('ja-JP', { hour12: false, milliseconds: true });
            const element = document.getElementById(target);
            element.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${message}</span>\n`;
        };

        async function checkEnvironment() {
            const result = document.getElementById('env-result');
            result.innerHTML = '';

            log('env-result', '=== ç’°å¢ƒãƒã‚§ãƒƒã‚¯é–‹å§‹ ===', 'info');

            // localStorage ãƒã‚§ãƒƒã‚¯
            const customerData = localStorage.getItem('customer_data');
            const customerToken = localStorage.getItem('customer_token');

            log('env-result', `localStorage.customer_data: ${customerData ? 'ã‚ã‚Š' : 'ãªã—'}`, customerData ? 'success' : 'error');
            if (customerData) {
                try {
                    const parsed = JSON.parse(customerData);
                    log('env-result', `  -> ID: ${parsed.id}, åå‰: ${parsed.last_name} ${parsed.first_name}, é›»è©±: ${parsed.phone}`, 'info');
                } catch (e) {
                    log('env-result', `  -> ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
                }
            }

            log('env-result', `localStorage.customer_token: ${customerToken ? 'ã‚ã‚Š' : 'ãªã—'}`, customerToken ? 'success' : 'error');

            // sessionStorage ãƒã‚§ãƒƒã‚¯
            log('env-result', '\n=== sessionStorage ãƒã‚§ãƒƒã‚¯ ===', 'info');
            const sessionKeys = [
                'existing_customer_id',
                'subscription_store_id',
                'subscription_menu_id',
                'subscription_store_name',
                'subscription_menu_name'
            ];

            sessionKeys.forEach(key => {
                const value = sessionStorage.getItem(key);
                log('env-result', `${key}: ${value || 'ãªã—'}`, value ? 'success' : 'warning');
            });

            // Cookie ãƒã‚§ãƒƒã‚¯
            log('env-result', '\n=== Cookie ãƒã‚§ãƒƒã‚¯ ===', 'info');
            log('env-result', `Cookies: ${document.cookie || 'ãªã—'}`, 'info');
        }

        async function checkCustomerData() {
            const result = document.getElementById('customer-result');
            result.innerHTML = '';

            log('customer-result', '=== é¡§å®¢ãƒ‡ãƒ¼ã‚¿è©³ç´°ç¢ºèª ===', 'info');

            // localStorage ã‹ã‚‰å–å¾—
            const customerDataStr = localStorage.getItem('customer_data');
            if (!customerDataStr) {
                log('customer-result', 'customer_data ãŒ localStorage ã«ã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            try {
                const customerData = JSON.parse(customerDataStr);
                log('customer-result', 'customer_data ãƒ‘ãƒ¼ã‚¹æˆåŠŸ:', 'success');
                log('customer-result', JSON.stringify(customerData, null, 2), 'info');

                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã® customer_id ã¨æ¯”è¼ƒ
                const sessionCustomerId = sessionStorage.getItem('existing_customer_id');
                log('customer-result', `\nlocalStorage ã® ID: ${customerData.id}`, 'info');
                log('customer-result', `sessionStorage ã® ID: ${sessionCustomerId}`, 'info');

                if (customerData.id != sessionCustomerId) {
                    log('customer-result', 'âš ï¸ ID ãŒä¸€è‡´ã—ã¾ã›ã‚“ï¼', 'error');
                } else {
                    log('customer-result', 'âœ… ID ãŒä¸€è‡´ã—ã¦ã„ã¾ã™', 'success');
                }

            } catch (e) {
                log('customer-result', `ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
            }
        }

        async function testAPIPatterns() {
            const result = document.getElementById('api-result');
            result.innerHTML = '';

            log('api-result', '=== API ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³å®Ÿè¡Œ ===', 'info');

            // ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³
            const patterns = [
                { customer_id: null, label: 'customer_id ãªã—' },
                { customer_id: 48, label: 'customer_id: 48 (é–“é•ã£ãŸID)' },
                { customer_id: 2, label: 'customer_id: 2 (æ­£ã—ã„ID)' },
                { customer_id: '2', label: 'customer_id: "2" (æ–‡å­—åˆ—)' },
            ];

            const testDate = '2025-09-25';

            for (const pattern of patterns) {
                log('api-result', `\n--- ${pattern.label} ---`, 'warning');

                const payload = {
                    store_id: 1,
                    menu_id: 1,
                    date: testDate,
                    time: '10:00'
                };

                if (pattern.customer_id !== null) {
                    payload.customer_id = pattern.customer_id;
                }

                try {
                    const response = await fetch('/api/check-availability', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();
                    log('api-result', `Request: ${JSON.stringify(payload)}`, 'info');
                    log('api-result', `Response: ${JSON.stringify(data)}`, data.available ? 'success' : 'error');

                } catch (e) {
                    log('api-result', `ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
                }
            }
        }

        async function simulateSubscriptionPage() {
            const result = document.getElementById('simulation-result');
            result.innerHTML = '';

            log('simulation-result', '=== ã‚µãƒ–ã‚¹ã‚¯äºˆç´„ãƒšãƒ¼ã‚¸å‹•ä½œã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ===', 'info');

            // ãƒšãƒ¼ã‚¸ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè¡Œ
            const customerData = JSON.parse(localStorage.getItem('customer_data') || '{}');
            let customerId = sessionStorage.getItem('existing_customer_id');

            log('simulation-result', `1. customerData ã‹ã‚‰å–å¾—:`, 'info');
            log('simulation-result', `   ${JSON.stringify(customerData)}`, 'info');

            log('simulation-result', `2. sessionStorage ã‹ã‚‰ existing_customer_id å–å¾—: "${customerId}"`, 'info');

            // ãƒšãƒ¼ã‚¸ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å†ç¾
            if (customerId && customerId !== 'null' && customerId !== 'undefined') {
                customerId = parseInt(customerId, 10) || customerId;
                log('simulation-result', `3. parseInt å¾Œã® customerId: ${customerId} (å‹: ${typeof customerId})`, 'warning');
            } else {
                if (customerData && customerData.id) {
                    customerId = customerData.id;
                    log('simulation-result', `3. customerData.id ã‹ã‚‰è¨­å®š: ${customerId}`, 'warning');
                }
            }

            const storeId = sessionStorage.getItem('subscription_store_id');
            const menuId = sessionStorage.getItem('subscription_menu_id');

            log('simulation-result', `\n4. æœ€çµ‚çš„ãªå€¤:`, 'info');
            log('simulation-result', `   storeId: ${storeId} (å‹: ${typeof storeId})`, 'info');
            log('simulation-result', `   menuId: ${menuId} (å‹: ${typeof menuId})`, 'info');
            log('simulation-result', `   customerId: ${customerId} (å‹: ${typeof customerId})`, 'info');

            // ãƒ†ã‚¹ãƒˆ API å‘¼ã³å‡ºã—
            log('simulation-result', `\n5. ã“ã®å€¤ã§APIã‚’ãƒ†ã‚¹ãƒˆ (2025-09-25 10:00):`, 'info');

            const payload = {
                store_id: storeId,
                menu_id: menuId,
                customer_id: customerId,
                date: '2025-09-25',
                time: '10:00'
            };

            try {
                const response = await fetch('/api/check-availability', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                log('simulation-result', `Request: ${JSON.stringify(payload)}`, 'info');
                log('simulation-result', `Response: ${JSON.stringify(data, null, 2)}`, data.available ? 'success' : 'error');

            } catch (e) {
                log('simulation-result', `ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
            }
        }

        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¢ãƒ‹ã‚¿ãƒ¼
        let originalFetch = window.fetch;
        let networkLog = [];

        function startNetworkMonitor() {
            log('network-result', '=== ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç›£è¦–é–‹å§‹ ===', 'success');
            log('network-result', 'åˆ¥ã‚¿ãƒ–ã§ã‚µãƒ–ã‚¹ã‚¯äºˆç´„ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ã¦ãã ã•ã„', 'warning');

            // fetch ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆ
            window.fetch = function(...args) {
                const [url, options] = args;

                if (url.includes('check-availability')) {
                    const requestData = {
                        url: url,
                        method: options?.method || 'GET',
                        body: options?.body ? JSON.parse(options.body) : null,
                        timestamp: new Date().toISOString()
                    };

                    log('network-result', `\nğŸ“¤ Request to ${url}:`, 'warning');
                    log('network-result', JSON.stringify(requestData.body, null, 2), 'info');

                    return originalFetch.apply(this, args)
                        .then(response => {
                            const clonedResponse = response.clone();
                            clonedResponse.json().then(data => {
                                log('network-result', `ğŸ“¥ Response:`, 'warning');
                                log('network-result', JSON.stringify(data, null, 2), response.ok ? 'success' : 'error');
                            });
                            return response;
                        });
                }

                return originalFetch.apply(this, args);
            };
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
        window.addEventListener('load', () => {
            checkEnvironment();
            // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç›£è¦–ã‚’è‡ªå‹•é–‹å§‹
            startNetworkMonitor();
        });
    </script>
</body>
</html>